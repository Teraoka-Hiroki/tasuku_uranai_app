<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodleã‚³ãƒ¼ã‚¹ ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã‚¢ãƒ—ãƒª</title>
    
    <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans JP"', 'sans-serif'],
                        mono: ['"Share Tech Mono"', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        brand: {
                            cyan: '#06b6d4',
                            purple: '#8b5cf6',
                            orange: '#f97316',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f172a; /* Slate 900 */
            background-image: 
                radial-gradient(at 0% 0%, rgba(6, 182, 212, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            color: #F3F4F6;
        }

        /* ã‚¬ãƒ©ã‚¹ãƒ¢ãƒ¼ãƒ•ã‚£ã‚ºãƒ ã‚«ãƒ¼ãƒ‰ */
        .st-card {
            background: rgba(30, 41, 59, 0.7); /* Slate 800 with opacity */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* 
         * æ©Ÿèƒ½å¤‰æ›´ç¦æ­¢ã®ãŸã‚ã€ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãªã©ã®è£…é£¾ã®ã¿è¿½åŠ 
         */

        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .slider-container {
            position: relative;
            padding: 10px 0;
        }

        input[type=range].styled-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }

        input[type=range].styled-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #ffffff;
            border: 4px solid #06b6d4; /* Cyan */
            box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
            cursor: grab;
            transition: transform 0.1s, box-shadow 0.2s;
            margin-top: -8px; /* Correct thumb alignment */
        }
        
        /* ç¸¦è»¸ç”¨ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ï¼ˆè‰²å¤‰æ›´ï¼‰ */
        #slider-y.styled-slider::-webkit-slider-thumb {
            border-color: #8b5cf6; /* Purple */
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.5);
        }

        input[type=range].styled-slider::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.2);
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
        .slider-tooltip {
            position: absolute;
            top: -20px;
            transform: translateX(-50%);
            background-color: #06b6d4;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            pointer-events: none;
            opacity: 0; 
            transition: opacity 0.2s;
        }
        
        .slider-container:hover .slider-tooltip {
            opacity: 1;
        }

        #val-y-tooltip {
            background-color: #8b5cf6;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(15, 23, 42, 0.5); 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #475569;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #64748b;
        }

        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
        #drop-zone {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(5px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            border: 4px dashed #06b6d4;
            transition: opacity 0.3s;
        }
        #drop-zone.active {
            display: flex;
        }

        /* ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ */
        #chat-container p { margin-bottom: 0.5em; }
        #chat-container p:last-child { margin-bottom: 0; }
        #chat-container ul { list-style-type: disc; margin-left: 1.5em; margin-top: 0.5em; }
        #chat-container strong { color: #67e8f9; }

        /* ã‚¿ã‚¤ãƒãƒ¼ãƒ•ã‚©ãƒ³ãƒˆ */
        .font-mono-clock {
            font-family: 'Share Tech Mono', monospace;
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        
        /* ãƒ•ã‚§ãƒ«ãƒŸæ¨å®šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”¨ */
        .fermi-slider::-webkit-slider-thumb {
            border-color: #ec4899 !important; /* Pink-500 */
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.5) !important;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-100 selection:bg-cyan-500 selection:text-white"
      ondragover="event.preventDefault(); document.getElementById('drop-zone').classList.add('active');" 
      ondragleave="document.getElementById('drop-zone').classList.remove('active');" 
      ondrop="handleDrop(event)">

    <!-- ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ -->
    <div id="drop-zone">
        <div class="text-center p-10 border-2 border-dashed border-gray-500 rounded-3xl">
            <p class="text-6xl mb-4 animate-bounce">ğŸ“‚</p>
            <p class="text-2xl font-bold text-white">ã“ã“ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p class="text-gray-400 mt-2">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™</p>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="max-w-[1440px] w-full mx-auto px-4 py-8 space-y-6">
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¨ãƒªã‚¢ -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-slate-800/50 backdrop-blur-md rounded-2xl p-6 border border-slate-700/50 shadow-lg animate-fade-in">
            <div class="w-full md:w-2/3">
                <div class="flex items-center gap-3 mb-2">
                    <span class="text-3xl">ğŸ“</span>
                    <h1 class="text-2xl md:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
                        Moodleã‚³ãƒ¼ã‚¹ ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã‚¢ãƒ—ãƒª
                    </h1>
                </div>
                <h2 class="text-xl font-bold text-white mb-4 pl-12">ã€ã‚¿ã‚¹ã‚¯ï¼ˆèª²é¡Œï¼‰å ã„ã€</h2>
                
                <!-- ä»Šæ—¥ã®åè¨€ -->
                <div class="mt-4 p-4 bg-slate-900/60 rounded-xl border-l-4 border-yellow-500 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-yellow-500/10 rounded-full blur-xl group-hover:bg-yellow-500/20 transition-all"></div>
                    <p class="text-xs font-bold text-yellow-500 mb-1 uppercase tracking-wider">Today's Quote</p>
                    <blockquote class="italic text-gray-200 text-lg font-serif z-10 relative">
                        "<span id="quote-text">èª­ã¿è¾¼ã¿ä¸­...</span>"
                    </blockquote>
                    <p class="text-right text-sm text-gray-400 mt-2 font-medium">â€” <span id="quote-author">...</span></p>
                </div>
            </div>

            <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« -->
            <div class="flex items-center mt-6 md:mt-0 bg-slate-900/80 p-3 pr-6 rounded-full border border-slate-700 shadow-xl ml-4 hover:border-cyan-500/50 transition-colors cursor-default">
                <img src="./teraoka.png" onerror="this.src='https://ui-avatars.com/api/?name=Teraoka&background=0f172a&color=fff'" alt="Profile" class="w-14 h-14 rounded-full object-cover border-2 border-cyan-500/30">
                <div class="text-right ml-4">
                    <p class="font-bold text-sm text-cyan-400">ãƒ†ãƒ©ã‚ªã‚«é›»å­ã®è‡ªç”±æ¢ç©¶ã‚¼ãƒŸ</p>
                    <p class="text-xs text-gray-400 max-w-[200px] leading-tight mt-1">è‡ªåˆ†ãŒä¾¡å€¤ã‚’ç½®ãã‚‚ã®ã«å‘ã‹ã£ã¦<br>ã“ã¤ã“ã¤åŠªåŠ›ã™ã‚‹å§¿ã»ã©<br>ç´ æ™´ã‚‰ã—ã„ã‚‚ã®ã¯ãªã„</p>
                </div>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚°ãƒªãƒƒãƒ‰ -->
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-6 animate-fade-in" style="animation-delay: 0.1s;">
            
            <!-- å·¦ã‚«ãƒ©ãƒ ï¼šè¨ºæ–­ãƒãƒ£ãƒ¼ãƒˆ -->
            <div class="xl:col-span-7 flex flex-col gap-6">
                <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div class="st-card border-t-4 border-t-cyan-500">
                    <h3 class="text-xl font-bold text-gray-100 mb-6 flex items-center">
                        <span class="bg-cyan-500/20 text-cyan-400 p-2 rounded-lg mr-3">ğŸ”</span>
                        ã‚ãªãŸã®èˆˆå‘³ãƒ»é–¢å¿ƒã‚’å…¥åŠ›
                    </h3>
                    
                    <!-- Xè»¸ -->
                    <div class="mb-8 slider-container group">
                        <div class="flex justify-between items-end mb-2 px-1">
                            <label class="text-sm font-bold text-gray-300 group-hover:text-cyan-400 transition-colors">Q1. èˆˆå‘³ãŒã‚ã‚‹åˆ†é‡ã¯ï¼Ÿ</label>
                            <span class="text-xs text-cyan-500 font-mono bg-cyan-950 px-2 py-1 rounded">X-Axis</span>
                        </div>
                        <div class="relative h-8 flex items-center">
                            <div id="val-x-tooltip" class="slider-tooltip font-mono">0.00</div>
                            <input type="range" id="slider-x" min="-5.0" max="3.0" step="0.1" value="0" class="styled-slider w-full" dir="rtl">
                        </div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mt-1 uppercase tracking-wider">
                            <span class="group-hover:text-gray-300 transition-colors">ğŸ“ æ•°å­¦ãƒ»ãƒ‡ãƒ¼ã‚¿åˆ†æ</span>
                            <span class="group-hover:text-gray-300 transition-colors">ğŸ’» Webãƒ»ã‚¢ãƒ—ãƒªé–‹ç™º</span>
                        </div>
                    </div>

                    <!-- Yè»¸ -->
                    <div class="slider-container group">
                        <div class="flex justify-between items-end mb-2 px-1">
                            <label class="text-sm font-bold text-gray-300 group-hover:text-purple-400 transition-colors">Q2. å­¦ç¿’ã‚¹ã‚¿ã‚¤ãƒ«ã®å¥½ã¿ã¯ï¼Ÿ</label>
                            <span class="text-xs text-purple-500 font-mono bg-purple-950 px-2 py-1 rounded">Y-Axis</span>
                        </div>
                        <div class="relative h-8 flex items-center">
                             <div id="val-y-tooltip" class="slider-tooltip font-mono">0.00</div>
                            <input type="range" id="slider-y" min="-2.0" max="1.5" step="0.1" value="0" class="styled-slider w-full" dir="rtl">
                        </div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mt-1 uppercase tracking-wider">
                            <span class="group-hover:text-gray-300 transition-colors">ğŸ“š æ•™ç§‘æ›¸ãƒ»åŸºç¤</span>
                            <span class="group-hover:text-gray-300 transition-colors">ğŸ¤– ç”ŸæˆAIãƒ»å®Ÿè·µ</span>
                        </div>
                    </div>
                </div>

                <!-- ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º -->
                <div class="st-card flex-grow flex flex-col relative overflow-hidden min-h-[500px]">
                    <div class="absolute inset-0 bg-gradient-to-b from-slate-800/50 to-slate-900/50 z-0"></div>
                    <!-- ã‚°ãƒªãƒƒãƒ‰è£…é£¾ -->
                    <div class="absolute inset-0" style="background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 40px 40px; pointer-events: none;"></div>

                    <div class="w-full h-[400px] relative z-10 flex-grow">
                        <canvas id="scatterChart"></canvas>
                    </div>
                    
                    <!-- è¨ºæ–­çµæœè¡¨ç¤º -->
                    <div class="mt-4 p-4 bg-slate-950/80 border border-slate-700 rounded-xl relative z-10 text-center shadow-inner">
                        <div id="cluster-comment">
                            <p class="text-gray-500 animate-pulse">åˆ†æä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ ï¼šãŠã™ã™ã‚ãƒªã‚¹ãƒˆ -->
            <div class="xl:col-span-5">
                <div class="st-card h-full flex flex-col border-t-4 border-t-green-500 max-h-[850px]">
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-100 flex items-center">
                                <span class="bg-green-500/20 text-green-400 p-2 rounded-lg mr-3">ğŸ“‹</span>
                                ãŠã™ã™ã‚ã‚³ãƒ¼ã‚¹
                            </h3>
                            <p class="text-xs font-bold text-gray-400 mt-1 ml-11">è¿‘ã„é †ã«è¡¨ç¤º</p>
                        </div>
                        <span class="text-xs bg-slate-700 text-white px-2 py-1 rounded-full border border-slate-600">Personalized</span>
                    </div>
                    
                    <div class="overflow-y-auto custom-scrollbar flex-grow pr-1 -mr-1">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-900/90 text-xs uppercase text-gray-400 sticky top-0 z-10 shadow-md">
                                <tr>
                                    <th class="px-4 py-3 font-bold rounded-l-lg">No.</th>
                                    <th class="px-4 py-3 font-bold">ã‚³ãƒ¼ã‚¹æ¦‚è¦</th>
                                    <th class="px-4 py-3 font-bold text-center rounded-r-lg">Status</th>
                                </tr>
                            </thead>
                            <tbody id="recommendation-table" class="divide-y divide-slate-700/50 text-sm">
                                <!-- JSã§æ³¨å…¥ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- é¡”èªè­˜ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="st-card bg-gradient-to-r from-slate-800 to-slate-900 border-l-4 border-l-orange-500 flex flex-col md:flex-row items-center justify-between gap-4 animate-fade-in" style="animation-delay: 0.2s;">
            <div class="flex items-center gap-4">
                <div class="bg-orange-500/20 p-3 rounded-full">
                    <span class="text-3xl">ğŸ˜Š</span>
                </div>
                <div>
                    <p class="text-lg font-bold text-orange-400">Smile Check!</p>
                    <p class="text-sm text-gray-300">ç¬‘é¡”ãŒã„ã„ã­ï¼ã¨è¨€ã‚ã‚ŒãŸã„ï¼šã‚³ãƒ¼ã‚¹ã«å–ã‚Šçµ„ã‚€å‰ã«ã€Œé¡”ä½“æ“ã€ã‚’ã—ã¦ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¾ã—ã‚‡ã†ï¼ï¼ï¼</p>
                </div>
            </div>
            <button id="emotion-btn" class="whitespace-nowrap bg-slate-700 hover:bg-orange-500 hover:text-white text-gray-200 px-6 py-2 rounded-lg font-bold transition-all duration-300 shadow-lg border border-slate-600 hover:border-orange-400 flex items-center gap-2">
                <span>ğŸ“¸</span> ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
            </button>
        </div>

        <!-- 2ã‚«ãƒ©ãƒ ï¼šãƒãƒ£ãƒƒãƒˆ & å­¦ç¿’è¨˜éŒ² -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in" style="animation-delay: 0.3s;">
            
            <!-- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆ (WebLLM) -->
            <div class="st-card flex flex-col h-[500px] border-t-4 border-t-blue-600 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-600/10 rounded-full blur-3xl pointer-events-none"></div>
                
                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2 z-10">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-600/20 p-2 rounded-lg text-2xl">ğŸ¤–</div>
                        <div>
                            <h3 class="text-lg font-bold text-white">å­¦ç¿’å¿œæ´ãƒ¡ãƒ³ã‚¿ãƒ¼ å¤§å‰AI</h3>
                            <p class="text-[10px] text-blue-300 uppercase tracking-widest">å‹‰å¼·ã®æ‚©ã¿ã‚’ç›¸è«‡ã—ã‚ˆã†ï¼ï¼ï¼  Powered by Llama-3.2</p>
                        </div>
                    </div>
                    <button id="reset-chat-btn" class="text-xs bg-slate-800 hover:bg-red-900/50 text-red-300 hover:text-red-200 px-3 py-1 rounded border border-slate-600 hover:border-red-700 transition-colors">
                        Reset
                    </button>
                </div>

                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
                <div id="llm-status" class="hidden mb-2 px-4 py-3 bg-slate-900/80 rounded-lg border border-blue-900/50 z-10">
                    <div class="flex justify-between text-xs text-blue-300 mb-1">
                        <span class="font-bold">Model Initializing...</span>
                        <span id="llm-status-text">æº–å‚™ä¸­...</span>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5 overflow-hidden">
                        <div id="llm-progress-bar" class="bg-blue-500 h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <div id="chat-container" class="flex-grow bg-slate-950/50 rounded-xl p-4 overflow-y-auto mb-4 custom-scrollbar border border-slate-700/50 z-10">
                    <!-- ãƒãƒ£ãƒƒãƒˆå±¥æ­´ -->
                </div>

                <div class="flex gap-2 z-10">
                    <input type="text" id="chat-input" class="flex-grow bg-slate-800 text-gray-100 border border-slate-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-500 transition-all" placeholder="ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ãŒé›£ã—ã„...">
                    <button id="send-chat-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold transition-all shadow-lg hover:shadow-blue-500/25">é€ä¿¡</button>
                </div>
            </div>

            <!-- å­¦ç¿’è¨˜éŒ² (Three Good Things) -->
            <div class="st-card flex flex-col h-[500px] border-t-4 border-t-yellow-500">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-yellow-100 flex items-center">
                        <span class="bg-yellow-500/20 text-yellow-400 p-2 rounded-lg mr-3 text-xl">ğŸ“</span>
                        Three Good Things: ä»Šæ—¥ã®ï¼“è¡Œå­¦ç¿’æ—¥è¨˜
                    </h3>
                    <span class="text-xs text-gray-400 bg-slate-800 px-2 py-1 rounded">Daily Log</span>
                </div>
                
                <!-- ä¿®æ­£ç‚¹1: è¦ªã‚³ãƒ³ãƒ†ãƒŠã® h-full ã‚’ flex-grow ã¨ min-h-0 ã«å¤‰æ›´ã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å•é¡Œã‚’è§£æ¶ˆ -->
                <div class="flex flex-col gap-4 flex-grow min-h-0">
                    <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
                    <div class="space-y-2">
                        <p class="text-xs text-gray-400 mb-1">ä»Šæ—¥å­¦ã‚“ã ã“ã¨ã‚’3ã¤è¨˜éŒ²ã—ã¦ã€æˆé•·ã‚’å¯è¦–åŒ–ã—ã‚ˆã†ã€‚</p>
                        <input type="text" id="record-line-1" class="w-full bg-slate-800 text-gray-100 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-yellow-500 focus:outline-none focus:bg-slate-900 transition-colors" placeholder="1. å­¦ã‚“ã ã“ã¨ãƒ»æ°—ã¥ããƒ»æ¬¡ã®è¡Œå‹•...">
                        <input type="text" id="record-line-2" class="w-full bg-slate-800 text-gray-100 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-yellow-500 focus:outline-none focus:bg-slate-900 transition-colors" placeholder="2. å­¦ã‚“ã ã“ã¨ãƒ»æ°—ã¥ããƒ»æ¬¡ã®è¡Œå‹•...">
                        <input type="text" id="record-line-3" class="w-full bg-slate-800 text-gray-100 border border-slate-600 rounded-lg px-3 py-2 text-sm focus:border-yellow-500 focus:outline-none focus:bg-slate-900 transition-colors" placeholder="3. å­¦ã‚“ã ã“ã¨ãƒ»æ°—ã¥ããƒ»æ¬¡ã®è¡Œå‹•...">
                        <button id="save-record-btn" class="w-full mt-2 bg-yellow-600 hover:bg-yellow-500 text-white py-2 rounded-lg font-bold transition-all shadow-md flex justify-center items-center gap-2">
                            <span>ğŸ’¾</span> ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜
                        </button>
                    </div>

                    <!-- å±¥æ­´ -->
                    <div class="flex-grow bg-slate-900/50 rounded-xl border border-slate-700/50 p-3 overflow-y-auto custom-scrollbar">
                        <h4 class="text-xs font-bold text-gray-400 mb-2 uppercase border-b border-slate-700 pb-1">History</h4>
                        <div id="record-history-list" class="flex flex-col gap-2 text-sm">
                            <p class="text-gray-500 text-center py-4">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é›†ä¸­ã‚¿ã‚¤ãƒãƒ¼ -->
        <div class="st-card bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 animate-fade-in" style="animation-delay: 0.4s;">
            <!-- ä¿®æ­£ç‚¹2: ã‚¿ã‚¤ãƒãƒ¼ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ  -->
            <div class="mb-6">
                <h3 class="text-lg font-bold text-gray-100 flex items-center mb-2">
                    <span class="bg-indigo-500/20 text-indigo-400 p-2 rounded-lg mr-3 text-xl">â³</span>
                    Focus Timer
                </h3>
                <p class="text-sm text-gray-400 ml-12">å‹‰å¼·æ™‚é–“ã‚’ç®¡ç†ã—ã‚ˆã†ï¼ï¼ï¼</p>
            </div>
            
            <div class="flex flex-col md:flex-row items-center justify-center gap-10">
                <!-- ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤º -->
                <div class="relative group">
                    <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                    <div class="relative w-72 h-36 bg-slate-950 rounded-xl border border-slate-700 flex items-center justify-center shadow-2xl">
                        <span id="timer-display" class="font-mono-clock text-7xl text-cyan-400 font-bold tracking-widest drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">25:00</span>
                    </div>
                </div>

                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div class="flex flex-col gap-4 w-full md:w-auto">
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                        <button onclick="setTimer(5)" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs text-gray-300 border border-slate-600 transition-colors">5 min</button>
                        <button onclick="setTimer(10)" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs text-gray-300 border border-slate-600 transition-colors">10 min</button>
                        <button onclick="setTimer(15)" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs text-gray-300 border border-slate-600 transition-colors">15 min</button>
                        <button onclick="setTimer(30)" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs text-gray-300 border border-slate-600 transition-colors">30 min</button>
                        <button onclick="setTimer(45)" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs text-gray-300 border border-slate-600 transition-colors">45 min</button>
                        <button onclick="setTimer(60)" class="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded text-xs text-gray-300 border border-slate-600 transition-colors">60 min</button>
                    </div>
                    <div class="flex gap-4">
                        <button id="timer-start-btn" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-cyan-500/20 transition-all transform active:scale-95">START</button>
                        <button id="timer-reset-btn" class="flex-1 bg-slate-700 hover:bg-red-900/80 text-white font-bold py-3 rounded-lg border border-slate-600 hover:border-red-500 transition-all">RESET</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ã‚§ãƒ«ãƒŸæ¨å®šï¼šæ‹æ„›æ–¹ç¨‹å¼ -->
        <div class="st-card border-t-4 border-t-pink-500 animate-fade-in" style="animation-delay: 0.5s;">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-pink-400 flex items-center mb-2">
                    <span class="bg-pink-500/20 text-pink-400 p-2 rounded-lg mr-3 text-xl">ğŸ’–</span>
                    ãƒ•ã‚§ãƒ«ãƒŸæ¨å®šï¼šThe Mathematics of Love
                </h3>
                <div class="ml-12 text-sm text-gray-300 space-y-2">
                    <p>ã‚¤ã‚®ãƒªã‚¹ã®æ•°å­¦è€…ãƒ”ãƒ¼ã‚¿ãƒ¼ãƒ»ãƒãƒƒã‚¯ã‚¹ã¯ã€2009å¹´ã®è«–æ–‡ "Why I Don't Have a Girlfriend?" ã§ã€ãƒ‰ãƒ¬ã‚¤ã‚¯ã®æ–¹ç¨‹å¼ï¼ˆéŠ€æ²³ç³»ã«çŸ¥çš„ç”Ÿå‘½ä½“ãŒå­˜åœ¨ã™ã‚‹ç¢ºç‡ã‚’è¨ˆç®—ã™ã‚‹å¼ï¼‰ã‚’å¿œç”¨ã—ã€è‡ªåˆ†ã«å½¼å¥³ãŒã§ãã‚‹ç¢ºç‡ã‚’ç®—å‡ºã—ã¾ã—ãŸã€‚</p>
                    <p class="text-xs text-gray-500">â€» æ°—åˆ†è»¢æ›ã«ã€ã“ã®ç†è«–ã‚’ä½¿ã£ã¦ã€Œç†æƒ³ã®ç›¸æ‰‹ã«å‡ºä¼šãˆã‚‹ç¢ºç‡ã€ã‚’ãƒ•ã‚§ãƒ«ãƒŸæ¨å®šã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-bold text-gray-400 mb-1">1. åœ°åŸŸã®äººå£ (äºº)</label>
                        <input type="number" id="fermi-pop" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-pink-500 outline-none" value="300000">
                    </div>

                    <div class="space-y-4">
                        <div class="slider-container">
                            <div class="flex justify-between text-xs mb-1">
                                <span>2. ç†æƒ³ã¨ã™ã‚‹å¹´é½¢å±¤ã®å‰²åˆ (%)</span>
                                <span id="val-fermi-age" class="text-pink-400 font-bold">20%</span>
                            </div>
                            <input type="range" id="fermi-age" min="1" max="100" value="20" class="styled-slider fermi-slider w-full">
                        </div>

                        <div class="slider-container">
                            <div class="flex justify-between text-xs mb-1">
                                <span>3. å¯¾è±¡ã¨ãªã‚‹æ€§åˆ¥ã®å‰²åˆ (%)</span>
                                <span id="val-fermi-sex" class="text-pink-400 font-bold">50%</span>
                            </div>
                            <input type="range" id="fermi-sex" min="1" max="100" value="50" class="styled-slider fermi-slider w-full">
                        </div>

                        <div class="slider-container">
                            <div class="flex justify-between text-xs mb-1">
                                <span>4. å­¦æ­´ãƒ»çŸ¥æ€§ãŒé‡£ã‚Šåˆã†å‰²åˆ (%)</span>
                                <span id="val-fermi-edu" class="text-pink-400 font-bold">20%</span>
                            </div>
                            <input type="range" id="fermi-edu" min="1" max="100" value="20" class="styled-slider fermi-slider w-full">
                        </div>

                        <div class="slider-container">
                            <div class="flex justify-between text-xs mb-1">
                                <span>5. æ€§æ ¼ãŒåˆã†å‰²åˆ (%)</span>
                                <span id="val-fermi-charm" class="text-pink-400 font-bold">10%</span>
                            </div>
                            <input type="range" id="fermi-charm" min="1" max="100" value="10" class="styled-slider fermi-slider w-full">
                        </div>

                        <div class="slider-container">
                            <div class="flex justify-between text-xs mb-1">
                                <span>6. å¤–è¦‹ãŒè¨±å®¹ç¯„å›²ã®å‰²åˆ (%)</span>
                                <span id="val-fermi-phys" class="text-pink-400 font-bold">10%</span>
                            </div>
                            <input type="range" id="fermi-phys" min="1" max="100" value="10" class="styled-slider fermi-slider w-full">
                        </div>

                        <div class="slider-container">
                            <div class="flex justify-between text-xs mb-1">
                                <span>7. å®Ÿéš›ã«å‡ºä¼šãˆã‚‹ç¢ºç‡ (%)</span>
                                <span id="val-fermi-meet" class="text-pink-400 font-bold">5%</span>
                            </div>
                            <input type="range" id="fermi-meet" min="1" max="100" value="5" class="styled-slider fermi-slider w-full">
                        </div>
                    </div>

                    <button id="fermi-calc-btn" class="w-full bg-pink-600 hover:bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-pink-500/30 transition-all transform active:scale-95">
                        åˆ¤å®šï¼
                    </button>
                </div>

                <!-- çµæœè¡¨ç¤º -->
                <div class="flex flex-col h-full bg-slate-900/50 rounded-xl border border-slate-700 p-4">
                    <div class="text-center mb-6 py-4 border-b border-slate-700/50">
                        <p class="text-gray-400 text-sm mb-1">æ¨è¨ˆã•ã‚Œã‚‹é‹å‘½ã®ç›¸æ‰‹ã®äººæ•°</p>
                        <p class="text-5xl font-mono-clock text-pink-400 font-bold tracking-wider drop-shadow-[0_0_10px_rgba(236,72,153,0.5)]">
                            <span id="fermi-result">0</span> <span class="text-lg text-gray-500">äºº</span>
                        </p>
                    </div>

                    <div class="flex-grow relative min-h-[250px]">
                        <canvas id="fermiChart"></canvas>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-700/50">
                        <p class="text-xs text-center text-cyan-300 font-bold">
                            ğŸ’¡ æ•™è¨“: ç¢ºç‡ãŒä½ãã¦ã‚‚ã€è¡Œå‹•ï¼ˆåˆ†æ¯ï¼‰ã‚’å¢—ã‚„ã›ã°å‡ºä¼šã„ã¯å¢—ãˆã‚‹ï¼<br>
                            ã¾ãšã¯èº«è¿‘ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚„Moodleã§ã®å­¦ã³åˆã„ã‚’å¤§åˆ‡ã«ã—ã‚ˆã†ã€‚
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AHPï¼ˆéšå±¤åˆ†ææ³•ï¼‰ï¼šæ„æ€æ±ºå®šã‚µãƒãƒ¼ãƒˆ -->
        <div class="st-card border-t-4 border-t-emerald-500 animate-fade-in" style="animation-delay: 0.6s;">
            <div class="mb-6">
                <h3 class="text-xl font-bold text-emerald-400 flex items-center mb-2">
                    <span class="bg-emerald-500/20 text-emerald-400 p-2 rounded-lg mr-3 text-xl">âš–ï¸</span>
                    æ„æ€æ±ºå®šã‚µãƒãƒ¼ãƒˆï¼šAHPï¼ˆéšå±¤åˆ†ææ³•ï¼‰
                </h3>
                <div class="ml-12 text-sm text-gray-300 space-y-2 bg-slate-800/50 p-4 rounded-lg">
                    <p>AHPã¯Analytic Hierarchy Processã®ç•¥ã§ã€éšå±¤åˆ†ææ³•ã€éšå±¤åŒ–æ„æ€æ±ºå®šæ³•ã¨ã‚‚å‘¼ã°ã‚Œã¾ã™ã€‚
                        AHPã¯ã€å•é¡Œè§£æ±ºã®ãŸã‚ã®æ•°å­¦çš„ãªæ‰‹æ³•ã‚’ç ”ç©¶ã™ã‚‹ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚ºãƒ»ãƒªã‚µãƒ¼ãƒã®åˆ†é‡ã‹ã‚‰ææ¡ˆã•ã‚Œã€
                        æ”¿åºœéƒ¨é–€ã‚„è»äº‹é ˜åŸŸã€ç”£æ¥­åˆ†é‡ãªã©ã§åºƒãç”¨ã„ã‚‰ã‚Œã‚‹æ„æ€æ±ºå®šã®ãŸã‚ã®æ‰‹æ³•ã§ã™ã€‚</p>
                    <p>æ„æ€æ±ºå®šã®å…¨ä½“åƒã‚’ã€ç›®çš„ãƒ»è©•ä¾¡åŸºæº–ãƒ»ä»£æ›¿æ¡ˆã®éšå±¤æ§‹é€ ã§ã‚ã‚‰ã‚ã—ã€
                        äººé–“ã®ä¸»è¦³çš„åˆ¤æ–­ã‚’ä¸€å¯¾æ¯”è¼ƒæ³•ã«ã‚ˆã£ã¦é‡ã¿ä»˜ã‘ã—ãŸçµæœã‹ã‚‰åˆç†çš„ãªåˆ¤æ–­ã‚’è¡Œã†ã‚‚ã®ã§ã™ã€‚</p>
                    <br>
                    <p>ã”è‡ªèº«ã®é¸æŠã™ã‚‹å†…å®¹ã«æ›¸ãæ›ãˆã¦ã¿ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8">
                <!-- Step 1: å®šç¾© -->
                <div class="p-4 bg-slate-900/50 rounded-xl border border-slate-700">
                    <h4 class="text-emerald-400 font-bold mb-4 border-b border-slate-700 pb-2">Step 1: æ§‹é€ ã®å®šç¾©</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-400 mb-1">ç›®çš„ (Goal)</label>
                            <input type="text" id="ahp-goal" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none" value="ã©ã®å¤§å­¦ã«é€²å­¦ã™ã‚‹ã‹ï¼Ÿ">
                        </div>
                        <div>
                            <!-- Spacer -->
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-400 mb-1">è©•ä¾¡åŸºæº– (Criteria)</label>
                            <div class="space-y-2">
                                <input type="text" id="ahp-criteria-1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none" value="å°‚æ”»åˆ†é‡">
                                <input type="text" id="ahp-criteria-2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none" value="å­¦è²»">
                                <input type="text" id="ahp-criteria-3" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none" value="åœ°åŸŸ">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-400 mb-1">ä»£æ›¿æ¡ˆ (Alternatives)</label>
                            <div class="space-y-2">
                                <input type="text" id="ahp-alt-1" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none" value="Aå¤§å­¦">
                                <input type="text" id="ahp-alt-2" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none" value="Bå¤§å­¦">
                                <input type="text" id="ahp-alt-3" class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:border-emerald-500 outline-none" value="Cå¤§å­¦">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: è©•ä¾¡åŸºæº–ã®ä¸€å¯¾æ¯”è¼ƒ -->
                <div class="p-4 bg-slate-900/50 rounded-xl border border-slate-700">
                    <h4 class="text-emerald-400 font-bold mb-4 border-b border-slate-700 pb-2">Step 2: è©•ä¾¡åŸºæº–ã®ä¸€å¯¾æ¯”è¼ƒï¼ˆã©ã¡ã‚‰ã‚’é‡è¦–ã—ã¾ã™ã‹ï¼Ÿï¼‰</h4>
                    <div id="ahp-criteria-comparison-container" class="space-y-6">
                        <!-- JSã§å‹•çš„ç”Ÿæˆã¾ãŸã¯ä¸‹è¨˜å›ºå®š -->
                        <!-- Row 1: Criteria 1 vs 2 -->
                        <div class="flex flex-col md:flex-row items-center justify-between gap-2 p-2 bg-slate-800/50 rounded">
                            <div class="w-full md:w-1/4 text-center md:text-right font-bold text-cyan-300 ahp-label-c1">å°‚æ”»åˆ†é‡</div>
                            <div class="flex items-center gap-2">
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-2" value="5" class="accent-emerald-500"><span class="text-[10px] text-gray-400">é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-2" value="3" class="accent-emerald-500"><span class="text-[10px] text-gray-400">ã‚„ã‚„é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-2" value="1" checked class="accent-emerald-500"><span class="text-[10px] text-gray-400">åŒã˜</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-2" value="0.333" class="accent-emerald-500"><span class="text-[10px] text-gray-400">ã‚„ã‚„é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-2" value="0.2" class="accent-emerald-500"><span class="text-[10px] text-gray-400">é‡è¦</span></label>
                            </div>
                            <div class="w-full md:w-1/4 text-center md:text-left font-bold text-purple-300 ahp-label-c2">å­¦è²»</div>
                        </div>
                        <!-- Row 2: Criteria 1 vs 3 -->
                        <div class="flex flex-col md:flex-row items-center justify-between gap-2 p-2 bg-slate-800/50 rounded">
                            <div class="w-full md:w-1/4 text-center md:text-right font-bold text-cyan-300 ahp-label-c1">å°‚æ”»åˆ†é‡</div>
                            <div class="flex items-center gap-2">
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-3" value="5" class="accent-emerald-500"><span class="text-[10px] text-gray-400">é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-3" value="3" class="accent-emerald-500"><span class="text-[10px] text-gray-400">ã‚„ã‚„é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-3" value="1" checked class="accent-emerald-500"><span class="text-[10px] text-gray-400">åŒã˜</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-3" value="0.333" class="accent-emerald-500"><span class="text-[10px] text-gray-400">ã‚„ã‚„é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-1-3" value="0.2" class="accent-emerald-500"><span class="text-[10px] text-gray-400">é‡è¦</span></label>
                            </div>
                            <div class="w-full md:w-1/4 text-center md:text-left font-bold text-orange-300 ahp-label-c3">åœ°åŸŸ</div>
                        </div>
                        <!-- Row 3: Criteria 2 vs 3 -->
                        <div class="flex flex-col md:flex-row items-center justify-between gap-2 p-2 bg-slate-800/50 rounded">
                            <div class="w-full md:w-1/4 text-center md:text-right font-bold text-purple-300 ahp-label-c2">å­¦è²»</div>
                            <div class="flex items-center gap-2">
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-2-3" value="5" class="accent-emerald-500"><span class="text-[10px] text-gray-400">é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-2-3" value="3" class="accent-emerald-500"><span class="text-[10px] text-gray-400">ã‚„ã‚„é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-2-3" value="1" checked class="accent-emerald-500"><span class="text-[10px] text-gray-400">åŒã˜</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-2-3" value="0.333" class="accent-emerald-500"><span class="text-[10px] text-gray-400">ã‚„ã‚„é‡è¦</span></label>
                                <label class="flex flex-col items-center cursor-pointer"><input type="radio" name="ahp-pair-c-2-3" value="0.2" class="accent-emerald-500"><span class="text-[10px] text-gray-400">é‡è¦</span></label>
                            </div>
                            <div class="w-full md:w-1/4 text-center md:text-left font-bold text-orange-300 ahp-label-c3">åœ°åŸŸ</div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: ä»£æ›¿æ¡ˆã®ä¸€å¯¾æ¯”è¼ƒ -->
                <div class="p-4 bg-slate-900/50 rounded-xl border border-slate-700">
                    <h4 class="text-emerald-400 font-bold mb-4 border-b border-slate-700 pb-2">Step 3: ä»£æ›¿æ¡ˆã®ä¸€å¯¾æ¯”è¼ƒï¼ˆã©ã¡ã‚‰ãŒè‰¯ã„ã§ã™ã‹ï¼Ÿï¼‰</h4>
                    
                    <div id="ahp-alt-comparisons">
                        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé–¢æ•°ã§ç”Ÿæˆã™ã‚‹ãŒã€åˆæœŸè¡¨ç¤ºç”¨ã«3ã‚»ãƒƒãƒˆç”¨æ„ -->
                        <!-- Criteria 1 -->
                        <div class="mb-6">
                            <h5 class="text-cyan-400 font-bold mb-2 text-sm">ã€<span class="ahp-label-c1">å°‚æ”»åˆ†é‡</span>ã€‘ã«ã¤ã„ã¦</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a1 w-1/4 text-right">Aå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a1-1-2" value="5"> <input type="radio" name="ahp-pair-a1-1-2" value="3"> <input type="radio" name="ahp-pair-a1-1-2" value="1" checked> <input type="radio" name="ahp-pair-a1-1-2" value="0.333"> <input type="radio" name="ahp-pair-a1-1-2" value="0.2">
                                    </div>
                                    <span class="ahp-label-a2 w-1/4 text-left">Bå¤§å­¦</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a1 w-1/4 text-right">Aå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a1-1-3" value="5"> <input type="radio" name="ahp-pair-a1-1-3" value="3"> <input type="radio" name="ahp-pair-a1-1-3" value="1" checked> <input type="radio" name="ahp-pair-a1-1-3" value="0.333"> <input type="radio" name="ahp-pair-a1-1-3" value="0.2">
                                    </div>
                                    <span class="ahp-label-a3 w-1/4 text-left">Cå¤§å­¦</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a2 w-1/4 text-right">Bå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a1-2-3" value="5"> <input type="radio" name="ahp-pair-a1-2-3" value="3"> <input type="radio" name="ahp-pair-a1-2-3" value="1" checked> <input type="radio" name="ahp-pair-a1-2-3" value="0.333"> <input type="radio" name="ahp-pair-a1-2-3" value="0.2">
                                    </div>
                                    <span class="ahp-label-a3 w-1/4 text-left">Cå¤§å­¦</span>
                                </div>
                            </div>
                        </div>

                         <!-- Criteria 2 -->
                         <div class="mb-6">
                            <h5 class="text-purple-400 font-bold mb-2 text-sm">ã€<span class="ahp-label-c2">å­¦è²»</span>ã€‘ã«ã¤ã„ã¦</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a1 w-1/4 text-right">Aå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a2-1-2" value="5"> <input type="radio" name="ahp-pair-a2-1-2" value="3"> <input type="radio" name="ahp-pair-a2-1-2" value="1" checked> <input type="radio" name="ahp-pair-a2-1-2" value="0.333"> <input type="radio" name="ahp-pair-a2-1-2" value="0.2">
                                    </div>
                                    <span class="ahp-label-a2 w-1/4 text-left">Bå¤§å­¦</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a1 w-1/4 text-right">Aå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a2-1-3" value="5"> <input type="radio" name="ahp-pair-a2-1-3" value="3"> <input type="radio" name="ahp-pair-a2-1-3" value="1" checked> <input type="radio" name="ahp-pair-a2-1-3" value="0.333"> <input type="radio" name="ahp-pair-a2-1-3" value="0.2">
                                    </div>
                                    <span class="ahp-label-a3 w-1/4 text-left">Cå¤§å­¦</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a2 w-1/4 text-right">Bå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a2-2-3" value="5"> <input type="radio" name="ahp-pair-a2-2-3" value="3"> <input type="radio" name="ahp-pair-a2-2-3" value="1" checked> <input type="radio" name="ahp-pair-a2-2-3" value="0.333"> <input type="radio" name="ahp-pair-a2-2-3" value="0.2">
                                    </div>
                                    <span class="ahp-label-a3 w-1/4 text-left">Cå¤§å­¦</span>
                                </div>
                            </div>
                        </div>

                         <!-- Criteria 3 -->
                         <div class="mb-6">
                            <h5 class="text-orange-400 font-bold mb-2 text-sm">ã€<span class="ahp-label-c3">åœ°åŸŸ</span>ã€‘ã«ã¤ã„ã¦</h5>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a1 w-1/4 text-right">Aå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a3-1-2" value="5"> <input type="radio" name="ahp-pair-a3-1-2" value="3"> <input type="radio" name="ahp-pair-a3-1-2" value="1" checked> <input type="radio" name="ahp-pair-a3-1-2" value="0.333"> <input type="radio" name="ahp-pair-a3-1-2" value="0.2">
                                    </div>
                                    <span class="ahp-label-a2 w-1/4 text-left">Bå¤§å­¦</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a1 w-1/4 text-right">Aå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a3-1-3" value="5"> <input type="radio" name="ahp-pair-a3-1-3" value="3"> <input type="radio" name="ahp-pair-a3-1-3" value="1" checked> <input type="radio" name="ahp-pair-a3-1-3" value="0.333"> <input type="radio" name="ahp-pair-a3-1-3" value="0.2">
                                    </div>
                                    <span class="ahp-label-a3 w-1/4 text-left">Cå¤§å­¦</span>
                                </div>
                                <div class="flex items-center justify-between bg-slate-800/30 p-2 rounded">
                                    <span class="ahp-label-a2 w-1/4 text-right">Bå¤§å­¦</span>
                                    <div class="flex gap-2">
                                        <input type="radio" name="ahp-pair-a3-2-3" value="5"> <input type="radio" name="ahp-pair-a3-2-3" value="3"> <input type="radio" name="ahp-pair-a3-2-3" value="1" checked> <input type="radio" name="ahp-pair-a3-2-3" value="0.333"> <input type="radio" name="ahp-pair-a3-2-3" value="0.2">
                                    </div>
                                    <span class="ahp-label-a3 w-1/4 text-left">Cå¤§å­¦</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="ahp-calc-btn" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-emerald-500/30 transition-all transform active:scale-95">
                    è¨ˆç®—ãƒ»è¨ºæ–­é–‹å§‹
                </button>

                <!-- çµæœã‚¨ãƒªã‚¢ -->
                <div id="ahp-result-area" class="hidden space-y-4">
                    <div class="bg-slate-900/80 p-6 rounded-xl border border-emerald-500/50">
                        <h4 class="text-xl font-bold text-white mb-4 text-center">ğŸ† ç·åˆè©•ä¾¡çµæœ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-6">
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <p class="text-xs text-gray-400 ahp-label-a1">Aå¤§å­¦</p>
                                <p id="ahp-score-1" class="text-2xl font-bold text-white">0.000</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <p class="text-xs text-gray-400 ahp-label-a2">Bå¤§å­¦</p>
                                <p id="ahp-score-2" class="text-2xl font-bold text-white">0.000</p>
                            </div>
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <p class="text-xs text-gray-400 ahp-label-a3">Cå¤§å­¦</p>
                                <p id="ahp-score-3" class="text-2xl font-bold text-white">0.000</p>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <h5 class="text-sm font-bold text-emerald-400 mb-2">ğŸ“Š è©³ç´°ã‚¦ã‚§ã‚¤ãƒˆï¼ˆé‡è¦åº¦ï¼‰</h5>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left text-gray-400">
                                    <thead class="text-xs uppercase bg-slate-700 text-gray-200">
                                        <tr>
                                            <th class="px-2 py-2">é …ç›®</th>
                                            <th class="px-2 py-2 ahp-label-c1">å°‚æ”»åˆ†é‡</th>
                                            <th class="px-2 py-2 ahp-label-c2">å­¦è²»</th>
                                            <th class="px-2 py-2 ahp-label-c3">åœ°åŸŸ</th>
                                            <th class="px-2 py-2 text-white font-bold">ç·åˆã‚¹ã‚³ã‚¢</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-700">
                                        <tr>
                                            <td class="px-2 py-2 font-bold text-emerald-300">åŸºæº–ã‚¦ã‚§ã‚¤ãƒˆ</td>
                                            <td id="ahp-w-c1" class="px-2 py-2">-</td>
                                            <td id="ahp-w-c2" class="px-2 py-2">-</td>
                                            <td id="ahp-w-c3" class="px-2 py-2">-</td>
                                            <td class="px-2 py-2 bg-slate-800">-</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-2 ahp-label-a1">Aå¤§å­¦</td>
                                            <td id="ahp-w-a1-c1" class="px-2 py-2">-</td>
                                            <td id="ahp-w-a1-c2" class="px-2 py-2">-</td>
                                            <td id="ahp-w-a1-c3" class="px-2 py-2">-</td>
                                            <td id="ahp-total-a1" class="px-2 py-2 font-bold text-white bg-slate-800">-</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-2 ahp-label-a2">Bå¤§å­¦</td>
                                            <td id="ahp-w-a2-c1" class="px-2 py-2">-</td>
                                            <td id="ahp-w-a2-c2" class="px-2 py-2">-</td>
                                            <td id="ahp-w-a2-c3" class="px-2 py-2">-</td>
                                            <td id="ahp-total-a2" class="px-2 py-2 font-bold text-white bg-slate-800">-</td>
                                        </tr>
                                        <tr>
                                            <td class="px-2 py-2 ahp-label-a3">Cå¤§å­¦</td>
                                            <td id="ahp-w-a3-c1" class="px-2 py-2">-</td>
                                            <td id="ahp-w-a3-c2" class="px-2 py-2">-</td>
                                            <td id="ahp-w-a3-c3" class="px-2 py-2">-</td>
                                            <td id="ahp-total-a3" class="px-2 py-2 font-bold text-white bg-slate-800">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div id="ahp-consistency-msg" class="p-3 bg-red-900/50 border border-red-500 rounded text-red-200 text-sm hidden">
                            âš ï¸ æ•´åˆåº¦(CI)ãŒ0.15ä»¥ä¸Šã§ã™ã€‚åˆ¤æ–­ã«çŸ›ç›¾ãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ¯”è¼ƒã‚’ã‚„ã‚Šç›´ã™ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
                        </div>

                        <button id="ahp-save-btn" class="mt-4 w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2 rounded-lg border border-slate-500 transition-colors flex items-center justify-center gap-2">
                            <span>ğŸ’¾</span> çµæœã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="mt-auto py-8 bg-slate-950 border-t border-slate-800 text-xs text-gray-500">
        <div class="max-w-[1440px] w-full mx-auto px-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-4">
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                    <p class="text-sm font-bold text-cyan-500 mb-1 flex items-center gap-2"><span>ğŸ•</span> Current Time</p>
                    <p id="current-time" class="text-xl text-gray-200 font-mono tracking-wide">--:--:--</p>
                </div>
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-800">
                    <p class="text-sm font-bold text-cyan-500 mb-2 flex items-center gap-2"><span>ğŸŒ¤ï¸</span> Weather Report</p>
                    <div id="weather-info" class="text-xs text-gray-400 grid grid-cols-2 sm:grid-cols-4 gap-y-2 gap-x-4">
                        <div class="flex items-center gap-1">æœ­å¹Œ: <span class="text-gray-300 font-bold">--Â°C</span></div>
                        <div class="flex items-center gap-1">ä»™å°: <span class="text-gray-300 font-bold">--Â°C</span></div>
                        <div class="flex items-center gap-1">æ±äº¬: <span class="text-gray-300 font-bold">--Â°C</span></div>
                        <div class="flex items-center gap-1">é‡‘æ²¢: <span class="text-gray-300 font-bold">--Â°C</span></div>
                        <div class="flex items-center gap-1">åå¤å±‹: <span class="text-gray-300 font-bold">--Â°C</span></div>
                        <div class="flex items-center gap-1">å¤§é˜ª: <span class="text-gray-300 font-bold">--Â°C</span></div>
                        <div class="flex items-center gap-1">ç¦å²¡: <span class="text-gray-300 font-bold">--Â°C</span></div>
                        <div class="flex items-center gap-1">é‚£è¦‡: <span class="text-gray-300 font-bold">--Â°C</span></div>
                    </div>
                </div>
            </div>
            <div class="text-center pt-4 border-t border-slate-900">
                <p>&copy; 2025 Teraoka-Denshi. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- é¡”è¡¨æƒ…èªè­˜ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´) -->
    <div id="emotion-modal" class="hidden fixed inset-0 bg-slate-950/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-slate-800 border border-slate-600 rounded-2xl shadow-2xl max-w-2xl w-full flex flex-col overflow-hidden animate-fade-in">
            <div class="p-4 bg-slate-900 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-lg font-bold text-gray-100 flex items-center gap-2"><span class="text-orange-400">ğŸ˜Š</span> é¡”ä½“æ“ãƒ¢ãƒ¼ãƒ‰</h2>
                <button id="close-emotion-modal" class="text-gray-400 hover:text-white text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-700 transition-colors">&times;</button>
            </div>
    
            <div class="relative bg-black aspect-video flex items-center justify-center overflow-hidden">
                <video id="emotion-video" class="w-full h-full object-cover" autoplay muted playsinline></video>
                <canvas id="emotion-canvas" class="absolute inset-0 w-full h-full"></canvas>
            </div>
            
            <div class="p-6 bg-slate-800">
                <div id="emotion-result" class="mb-4 p-4 bg-slate-900 border border-slate-700 rounded-xl text-center h-20 flex items-center justify-center">
                    <p class="text-gray-400 animate-pulse">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„...</p>
                </div>
                <button id="capture-emotion-btn" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg transition-colors">ç¾åœ¨ã®è¡¨æƒ…ã‚’ã‚·ãƒ§ãƒƒãƒˆ</button>
            </div>
        </div>
    </div>

    <!-- 
      ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ 
      æ³¨æ„: å…ƒã®ã‚³ãƒ¼ãƒ‰ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ã«ç¶­æŒã—ã¦ã„ã¾ã™ã€‚
    -->
    <script>
    // ---------------------------------------------------------
    // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿å®šç¾©
    // ---------------------------------------------------------
    const clusterDescriptions = {
        0: { title: "ã€ŒAIç ”ç©¶è€…ãƒ»ãƒãƒƒã‚«ãƒ¼ (ç†è«–Ã—å¿œç”¨)ã€", desc: "æ•°ç†ãƒ¢ãƒ‡ãƒ«ã¨ç”ŸæˆAIæŠ€è¡“ã®ä¸¡æ–¹ã‚’æ·±ãæ¢ç©¶ã—ãŸã„ç ”ç©¶å¿—å‘ã‚¿ã‚¤ãƒ—ã€‚" },
        1: { title: "ã€Œãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹åŸºç¤ (ç†è«–Ã—åŸºç¤)ã€", desc: "ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ã‚„æ•°å­¦çš„èƒŒæ™¯ã‚’ã—ã£ã‹ã‚Šå›ºã‚ãŸã„ç†è«–é‡è¦–ã‚¿ã‚¤ãƒ—ã€‚" },
        2: { title: "ã€ŒITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢åŸºç¤ (WebÃ—åŸºç¤)ã€", desc: "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚„Webã®ä»•çµ„ã¿ãªã©ã€ITã®åŸºç¤ä½“åŠ›ã‚’ã¤ã‘ãŸã„ã‚¿ã‚¤ãƒ—ã€‚" },
        3: { title: "ã€Œã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ãƒ»ç·åˆ (ãƒãƒ©ãƒ³ã‚¹å‹)ã€", desc: "AIãƒ»æƒ…å ±ã®åŸºç¤ã‹ã‚‰å¿œç”¨ã¾ã§ã‚’ãƒãƒ©ãƒ³ã‚¹ã‚ˆãå­¦ã³ãŸã„ã‚¿ã‚¤ãƒ—ã€‚" },
        4: { title: "ã€ŒAIã‚¢ãƒ—ãƒªã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼ (WebÃ—å¿œç”¨)ã€", desc: "ç†å±ˆã‚ˆã‚Šã‚‚å‹•ãã‚‚ã®ã‚’ï¼ç”ŸæˆAIã‚„WebæŠ€è¡“ã§ã‚¢ãƒ—ãƒªã‚’ä½œã‚ŠãŸã„ã‚¿ã‚¤ãƒ—ã€‚" }
    };

    // ---------------------------------------------------------
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆCSVãƒ‡ãƒ¼ã‚¿
    // ---------------------------------------------------------
    const defaultCsvData = `ã‚³ãƒ¼ã‚¹No,ã‚³ãƒ¼ã‚¹åï¼ˆçŸ­ç¸®ï¼‰,æ•°ç†ãƒ¢ãƒ‡ãƒ«,è­˜åˆ¥AI,ç”ŸæˆAI,DS,ãƒãƒƒãƒˆ,æ•™ç§‘æƒ…å ±,è©•ä¾¡ã®æ ¹æ‹ ã¨ç‰¹è¨˜äº‹é …,Factor1_Score,Factor2_Score,Cluster,Recommended_Order
    24,RAGã€åŠã£ã¡ã‚ƒã‚“ã€,2,2,5,3,3,4,ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢(Embedding)ã€ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²ã€RAGã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰,-1.4875803891596262,-1.4622888277454569,0,1
    21,LLMå…¥é–€,3,2,4,3,3,4,LLMæ¦‚è«–ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã€APIæ´»ç”¨ã®åŸºç¤,-0.9025888761481634,-1.2874290985724908,0,2
    1,TSPæœ€é©åŒ–,5,1,1,2,2,4,ã‚°ãƒ©ãƒ•ç†è«–ã€ãƒ’ãƒ¥ãƒ¼ãƒªã‚¹ãƒ†ã‚£ã‚¯ã‚¹æ¢ç´¢ã€NPå›°é›£å•é¡Œã¸ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ,0.0071368877825889,-0.8784721667106025,0,3
    11,AIæ¢åµ(æœ€é©åŒ–),5,1,1,3,3,4,é‡å­ã‚¢ãƒ‹ãƒ¼ãƒªãƒ³ã‚°(Fixstars Amplify)ã¨çµ„åˆã›æœ€é©åŒ–,0.1373681576696952,-0.7005292012959694,0,4
    20,ãŠã›ã¡æœ€é©åŒ–,5,1,1,3,3,4,é‡å­ã‚¢ãƒ‹ãƒ¼ãƒªãƒ³ã‚°ã€ã‚¤ã‚¸ãƒ³ã‚°ãƒ¢ãƒ‡ãƒ«ã€åˆ¶ç´„æ¡ä»¶ã®å®šå¼åŒ–,0.1373681576696952,-0.7005292012959694,0,5
    9,ç”ŸæˆAIåŸºç¤(æ•°å­—),4,3,5,4,2,4,æ½œåœ¨ç©ºé–“ã®æ•°å­¦ã€VAEã®ç¢ºç‡åˆ†å¸ƒã€GANã«ã‚ˆã‚‹ç”»åƒç”Ÿæˆ,0.7085086740501467,-1.570588414234168,0,6
    10,LLMåŸºç¤(Transf),5,2,5,3,2,4,Q/K/Vè¡Œåˆ—æ¼”ç®—ã€Positional Encodingã€ç¿»è¨³ãƒ¢ãƒ‡ãƒ«å®Ÿè£…,0.3186559168962835,-1.8031427282744463,0,7
    25,æ™‚ç³»åˆ—åˆ†æå…¥é–€,5,2,2,5,2,4,ARIMA/SARIMAãƒ¢ãƒ‡ãƒ«ã€å®šå¸¸æ€§æ¤œå®š(ADF)ã€è‡ªå·±ç›¸é–¢,1.875627424606476,-0.7803706849421969,1,8
    19,CNNåŸºç¤,4,5,2,4,1,4,ç•³ã¿è¾¼ã¿æ¼”ç®—ã€ã‚«ãƒ¼ãƒãƒ«ã€ãƒ—ãƒ¼ãƒªãƒ³ã‚°ã€ã‚¹ã‚¯ãƒ©ãƒƒãƒå®Ÿè£…,2.0811428111644115,-0.779047012499893,1,9
    41,ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰å”èª¿,5,3,1,5,2,4,å”èª¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦ã€è¡Œåˆ—æ¼”ç®—,2.270983513232195,-0.4847172819619508,1,10
    2,Transformeræ ªä¾¡äºˆæ¸¬,5,5,3,5,2,5,Attentionæ©Ÿæ§‹ã®æ•°ç†ã€æ™‚ç³»åˆ—ãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒï¼ˆCNN/LSTM/Transformerï¼‰,2.197296018407401,0.1866100155061296,1,11
    3,ã‚¢ãƒŠãƒ­ã‚°ãƒ¡ãƒ¼ã‚¿ãƒ¼èª­å–,4,5,1,5,2,5,ç”»åƒç‰¹å¾´æŠ½å‡º(VGG16)ã¨å›å¸°åˆ†æ(LightGBM)ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ¢ãƒ‡ãƒ«,2.010299650026917,0.8110010491994164,1,12
    16,Irisæ©Ÿæ¢°å­¦ç¿’,4,5,1,5,2,5,æ±ºå®šæœ¨ãƒ»kNNã®å¢ƒç•Œç·šå¯è¦–åŒ–ã€ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´,2.010299650026917,0.8110010491994164,1,13
    31,ç”»åƒAI FT,4,5,1,4,2,5,ResNet/VGG16è»¢ç§»å­¦ç¿’ã€æ®‹å·®æ¥ç¶šã€CIFAR-10åˆ†é¡,1.4308114684873103,0.699240408966418,1,14
    13,LLM FTæ¢ç©¶,4,5,2,5,3,5,BERTæ§‹é€ ç†è§£ã€äº‹å‰å­¦ç¿’ã‚¿ã‚¹ã‚¯(MLM/NSP)ã€æ–‡æ›¸åˆ†é¡,1.4283776901640903,0.6107664534256336,1,15
    7,ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯DS,3,4,1,5,2,5,ãƒ‡ãƒ¼ã‚¿å‰å‡¦ç†ã€EDAï¼ˆæ¢ç´¢çš„ãƒ‡ãƒ¼ã‚¿åˆ†æï¼‰ã€æ±ºå®šæœ¨ã«ã‚ˆã‚‹åˆ†é¡,1.2952821448103882,0.8733217589570395,1,16
    43,ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°,3,4,1,5,2,5,K-meansæ³•ã€ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ã€éšå±¤å‹ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°,1.2952821448103882,0.8733217589570395,1,17
    27,æƒ…å ±Iå…±ãƒ†(3-4å•),3,1,1,5,1,5,ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãƒˆãƒ¬ãƒ¼ã‚¹ã€ç›¸é–¢ä¿‚æ•°ã€ç®±ã²ã’å›³ã®èª­è§£,0.9564659352167112,0.7194299877009191,1,18
    32,æƒ…å ±II(ãƒ‡ãƒ¼ã‚¿),5,1,1,5,3,5,é‡å›å¸°åˆ†æã€ä¸»æˆåˆ†åˆ†æ(PCA)ã€æ¬¡å…ƒå‰Šæ¸›ã®æ•°ç†,0.9626050415139824,0.6686802544992858,1,19
    35,æƒ…å ±I(ãƒ¢ãƒ‡ãƒ«åŒ–),5,1,1,4,2,5,ç¢ºå®šãƒ»ç¢ºç‡ãƒ¢ãƒ‡ãƒ«ã€ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­æ³•ã€ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯æ›²ç·š,0.8323737716268763,0.4907372890846527,1,20
    18,NNæ¢æ¤œéšŠ,5,4,1,3,3,5,ãƒ‘ãƒ¼ã‚»ãƒ—ãƒˆãƒ­ãƒ³ã®æ•°ç†ã€èª¤å·®é€†ä¼æ’­æ³•ã€æ´»æ€§åŒ–é–¢æ•°,0.5917017996809465,0.5328684201077747,1,21
    22,NLPåŸºç¤(TF-IDF),5,3,4,5,4,5,TF-IDFçµ±è¨ˆãƒ¢ãƒ‡ãƒ«ã€ãƒ™ã‚¯ãƒˆãƒ«ç©ºé–“ãƒ¢ãƒ‡ãƒ«ã€ã‚³ã‚µã‚¤ãƒ³é¡ä¼¼åº¦,0.6407350660612885,-0.0059152191356753,1,22
    33,æƒ…å ±II(Master),3,1,1,5,2,4,ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ãƒ—ãƒ­ã‚»ã‚¹(TDSP)ã®ä½“ç³»åŒ–ã¨å®Ÿè·µ,0.8409485027991371,-0.3600758624467047,1,23
    44,ãƒãƒ¼ãƒ æ¢ç©¶,3,1,1,5,2,4,ãƒãƒ¼ãƒ DSãƒ—ãƒ­ã‚»ã‚¹(TDSP)ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã€æ¬ æå€¤å‡¦ç†,0.8409485027991371,-0.3600758624467047,1,24
    14,æ€§æ ¼è¨ºæ–­BERT,4,5,1,4,3,4,é©åˆç‡ãƒ»å†ç¾ç‡ã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«è©•ä¾¡ã€Kaggleãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆåˆ©ç”¨,1.3152940360697365,-0.3802654411812057,1,25
    42,ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ,3,5,1,5,3,4,å½¢æ…‹ç´ è§£æ(Janome)ã€æ„Ÿæƒ…åˆ†æã€ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰,1.4424557528082067,-0.176947609165756,1,26
    12,æ–‡ç« ã‚¹ã‚¿ã‚¤ãƒ«åˆ†æ,5,3,3,5,3,5,å¤šæ¬¡å…ƒå°ºåº¦æ§‹æˆæ³•(MDS)ã€ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ã€è¨ˆé‡æ–‡çŒ®å­¦,1.2226570259241152,0.1943193766381075,1,27
    5,AIã®åŸºç¤,2,4,4,2,2,5,AIå²ã€è­˜åˆ¥/ç”Ÿæˆã®æ¦‚å¿µåŒºåˆ†ã€ç¤¾ä¼šå®Ÿè£…ã¸ã®å€«ç†çš„è€ƒå¯Ÿ,-1.2935040092405476,-0.1696537328257567,2,28
    17,ç‰©ç†æ¢ç©¶(å…‰),5,1,3,2,4,5,ã‚¹ãƒãƒ«ã®æ³•å‰‡ã€ãƒ•ã‚§ãƒ«ãƒãƒ¼ã®åŸç†ã€æœ€çŸ­çµŒè·¯æ¢ç´¢(A*),-1.4904465111779914,-0.1332531829289093,2,29
    4,PythonåŸºç¤,2,1,1,2,2,5,ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªä»•æ§˜ã€åˆ¶å¾¡æ§‹æ–‡ã€é–¢æ•°ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åŸºç¤,-1.6835819858557466,0.5418875839660108,2,30
    37,æƒ…å ±I(ãƒ‡ã‚¶ã‚¤ãƒ³),2,1,1,2,3,5,ãƒ‡ã‚¶ã‚¤ãƒ³æ€è€ƒã€HCDã€ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã€è‘—ä½œæ¨©,-2.1328388975082477,0.6080699091476456,2,31
    34,æƒ…å ±II(ã‚·ã‚¹ãƒ†ãƒ ),1,3,1,3,5,5,æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ(DFD/UML)ã€ãƒ†ã‚¹ãƒˆæ‰‹æ³•ã€Webå®Ÿè£…,-2.3788089232439926,1.002225355576022,2,32
    15,æ•°ç†æœ€é©åŒ–å†’é™º,5,1,2,3,2,5,ç·šå½¢è¨ˆç”»æ³•(PuLP)ã€ãƒŠãƒƒãƒ—ã‚¶ãƒƒã‚¯å•é¡Œã€å³å¯†è§£ã¨è¿‘ä¼¼è§£,0.120220541876943,0.1125597278962367,3,33
    26,æƒ…å ±Iå…±ãƒ†(1-2å•),4,1,2,4,3,5,ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ‡ã‚¸ã‚¿ãƒ«è¨¼æ˜ã€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã€æƒ…å ±ç¤¾ä¼š,-0.2018746530370869,0.3820598850933214,3,34
    8,æ¢ç©¶ã®åŸºç¤,3,3,2,3,2,5,PPDACã‚µã‚¤ã‚¯ãƒ«ã€ä»®èª¬æ¤œè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã€ç›¸é–¢ä¿‚æ•°ã¨æ•£å¸ƒå›³,-0.2590503068945444,0.3541470755107967,3,35
    40,æƒ…å ±I(ã‚¢ãƒ«ã‚´),4,1,1,3,2,5,æ¢ç´¢ãƒ»æ•´åˆ—ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€è¨ˆç®—é‡(ã‚ªãƒ¼ãƒ€ãƒ¼)ã€ãƒ‡ãƒ¼ã‚¿æ§‹é€ ,-0.1994408747138669,0.4705338406341059,3,36
    36,æƒ…å ±I(ã‚³ãƒ³ãƒ”),3,1,1,3,1,5,ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿5å¤§è£…ç½®ã€2é€²æ•°æ¼”ç®—ã€æµ®å‹•å°æ•°ç‚¹èª¤å·®,-0.2025104278625027,0.4959087072349226,3,37
    39,DBåŸºç¤(SQL),2,1,1,5,3,5,ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ¢ãƒ‡ãƒ«ã€SQL(JOIN/GROUP BY)ã€æ­£è¦åŒ–,-0.3943743528894263,0.9433518298466405,3,38
    38,æƒ…å ±I(ãƒãƒƒãƒˆ),3,1,1,5,5,5,ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯éšå±¤ã€Wi-Fiã€ãƒ‘ã‚±ãƒƒãƒˆé€šä¿¡ã€çµ±è¨ˆçš„åˆ†æ,-0.8405617113932913,0.9841592884274584,3,39
    6,Pythonã‚²ãƒ¼ãƒ åˆ¶ä½œ,3,1,1,2,1,5,ç‰©ç†æ¼”ç®—ï¼ˆè¡çªåˆ¤å®šï¼‰ã€åº§æ¨™è¨ˆç®—ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒ‰ãƒªãƒ–ãƒ³å‡¦ç†,-0.7819986094021096,0.3841480670019243,3,40
    23,æ¼¢å­—ã—ã‚Šã¨ã‚ŠBot,1,1,5,2,3,4,LLM API(Gemini)åˆ©ç”¨ã€å½¢æ…‹ç´ è§£æã€ã‚¢ãƒ—ãƒªé–‹ç™º,-2.782086075915762,-1.511728758220832,4,41
    29,Webã‚¢ãƒ—ãƒªæ´»ç”¨,1,1,1,2,5,4,Web APIé€£æºã€JSONãƒ‘ãƒ¼ã‚¹ã€éåŒæœŸé€šä¿¡,-3.149939706379458,-0.3136964240358919,4,42
    30,Webã®æ­´å²,1,1,3,1,5,5,ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå²ã€TCP/IPã€Web3.0ã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰åŸºç¤,-4.328497463574644,0.1873972691495332,4,43
    28,Webåˆ¶ä½œåŸºç¤,1,1,4,1,5,5,ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰(HTML/CSS/JS)ã€GitHub Copilotæ´»ç”¨,-4.461162511784971,-0.0790196518058843,4,44
    `;

    // ---------------------------------------------------------
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
    // ---------------------------------------------------------
    let courseData = [];
    let chartInstance = null;
    let clusterCentroids = {};
    let userPos = { x: 0, y: 0 };

    // â‘¢å­¦ç¿’æ¸ˆã¿ã‚³ãƒ¼ã‚¹ã®ä¿å­˜ç”¨ã‚»ãƒƒãƒˆ
    const LEARNED_STORAGE_KEY = 'moodle-app-learned-courses';
    let learnedCourses = new Set();

    const clusterColors = [
        { bg: 'rgba(34, 211, 238, 0.7)', border: 'rgba(34, 211, 238, 1)' }, // 0: AIç ”ç©¶è€… (Cyan)
        { bg: 'rgba(163, 230, 53, 0.7)', border: 'rgba(163, 230, 53, 1)' }, // 1: DSåŸºç¤ (Lime)
        { bg: 'rgba(251, 146, 60, 0.7)', border: 'rgba(251, 146, 60, 1)' }, // 2: ITåŸºç¤ (Orange)
        { bg: 'rgba(192, 132, 252, 0.7)', border: 'rgba(192, 132, 252, 1)' }, // 3: ç·åˆ (Purple)
        { bg: 'rgba(156, 163, 175, 0.7)', border: 'rgba(156, 163, 175, 1)' }  // 4: ãã®ä»–
    ];

    // ---------------------------------------------------------
    // åˆæœŸåŒ–
    // ---------------------------------------------------------
    document.addEventListener('DOMContentLoaded', () => {
        // 1. ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®è¨­å®š
        setupSliderControl('slider-x', 'val-x-tooltip', (val) => {
            userPos.x = parseFloat(val);
            updateApp();
        });

        setupSliderControl('slider-y', 'val-y-tooltip', (val) => {
            userPos.y = parseFloat(val);
            updateApp();
        });

        // 2. CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®è¨­å®š
        const fileInput = document.getElementById('csv-upload');
        if (fileInput) {
            fileInput.addEventListener('change', handleFileUpload);
        }

        // 3. å­¦ç¿’çŠ¶æ³ã®èª­ã¿è¾¼ã¿
        loadLearnedState();

        // 4. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        loadInitialData();

        // 5. ç¾åœ¨æ™‚åˆ»ã®è¡¨ç¤º
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);

        // 6. å¤©æ°—æƒ…å ±ã®å–å¾—
        fetchWeatherData();
        setInterval(fetchWeatherData, 600000); // 10åˆ†ã”ã¨ã«æ›´æ–°

        // 7. é¡”è¡¨æƒ…èªè­˜ã®åˆæœŸåŒ–
        initializeEmotionDetection();

        // 8. ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®åˆæœŸåŒ– (New: WebLLM)
        initializeWebLLMChatbot();

        // 9. åè¨€ã®è¡¨ç¤º
        displayRandomQuote();

        // 10. å­¦ç¿’è¨˜éŒ²ã®åˆæœŸåŒ–
        initializeLearningRecord();
        
        // 11. ãƒ•ã‚§ãƒ«ãƒŸæ¨å®šã®åˆæœŸåŒ–
        initializeFermi();

        // 12. AHPã®åˆæœŸåŒ–
        initializeAHP();
    });

    // ---------------------------------------------------------
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼åˆ¶å¾¡
    // ---------------------------------------------------------
    function setupSliderControl(sliderId, tooltipId, onChangeCallback) {
        const slider = document.getElementById(sliderId);
        const tooltip = document.getElementById(tooltipId);
        const isRtl = slider.getAttribute('dir') === 'rtl';

        function updateView() {
            const val = parseFloat(slider.value);
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            
            tooltip.textContent = val.toFixed(2);
            let percentage = ((val - min) / (max - min)) * 100;
            
            // è‰²å®šæ•°å®šç¾©
            const colorLeft = sliderId === 'slider-x' ? '#06b6d4' : '#8b5cf6'; // Cyan or Purple
            const colorBg = '#334155'; // Slate-700

            if (isRtl) {
                const leftPos = ((max - val) / (max - min)) * 100;
                slider.style.background = `linear-gradient(to right, ${colorLeft} ${leftPos}%, ${colorBg} ${leftPos}%)`;
                const thumbWidth = 24;
                const offset = (thumbWidth / 2) - (thumbWidth * (leftPos / 100));
                tooltip.style.left = `calc(${leftPos}% + ${offset}px)`;
            } else {
                slider.style.background = `linear-gradient(to right, ${colorLeft} ${percentage}%, ${colorBg} ${percentage}%)`;
                const thumbWidth = 24;
                const offset = (thumbWidth / 2) - (thumbWidth * (percentage / 100));
                tooltip.style.left = `calc(${percentage}% + ${offset}px)`;
            }
            onChangeCallback(val);
        }
        slider.addEventListener('input', updateView);
        updateView();
    }

    // ---------------------------------------------------------
    // CSVå‡¦ç†
    // ---------------------------------------------------------
    function handleDrop(e) {
        e.preventDefault();
        document.getElementById('drop-zone').classList.remove('active');
        const file = e.dataTransfer.files[0];
        if (file && file.name.endsWith('.csv')) {
            const reader = new FileReader();
            reader.onload = function(e) { parseCSV(e.target.result); };
            reader.readAsText(file);
        } else {
            alert("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚");
        }
    }

    function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) { parseCSV(e.target.result); };
        reader.readAsText(file);
    }

    async function loadInitialData() {
        try {
            const response = await fetch('course_learning_path.csv');
            if (response.ok) {
                const csvText = await response.text();
                parseCSV(csvText);
            } else {
                throw new Error("Local file not found");
            }
        } catch (error) {
            console.log("Using embedded default data.");
            parseCSV(defaultCsvData);
        }
    }

    function parseCSV(csvText) {
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                courseData = results.data.map((row, index) => ({
                    id: row['ã‚³ãƒ¼ã‚¹No'],
                    name: row['ã‚³ãƒ¼ã‚¹åï¼ˆçŸ­ç¸®ï¼‰'],
                    desc: row['è©•ä¾¡ã®æ ¹æ‹ ã¨ç‰¹è¨˜äº‹é …'],
                    f1: row['Factor1_Score'], 
                    f2: row['Factor2_Score'], 
                    cluster: row['Cluster'] !== undefined ? row['Cluster'] : 4,
                    originalIndex: index
                })).filter(item => item.name && item.f1 != null && item.f2 != null);
                
                calculateCentroids();
                if (chartInstance) chartInstance.destroy();
                initChart();
                updateApp();
            }
        });
    }

    function calculateCentroids() {
        const sums = {};
        courseData.forEach(c => {
            if (!sums[c.cluster]) sums[c.cluster] = { x: 0, y: 0, count: 0 };
            sums[c.cluster].x += c.f1;
            sums[c.cluster].y += c.f2;
            sums[c.cluster].count++;
        });
        clusterCentroids = {};
        Object.keys(sums).forEach(k => {
            clusterCentroids[k] = {
                x: sums[k].x / sums[k].count,
                y: sums[k].y / sums[k].count
            };
        });
    }

    // ---------------------------------------------------------
    // å­¦ç¿’çŠ¶æ³ç®¡ç†æ©Ÿèƒ½
    // ---------------------------------------------------------
    function loadLearnedState() {
        const stored = localStorage.getItem(LEARNED_STORAGE_KEY);
        if (stored) {
            try {
                const arr = JSON.parse(stored);
                learnedCourses = new Set(arr);
            } catch (e) {
                console.error("Failed to load learned state", e);
                learnedCourses = new Set();
            }
        }
    }

    function saveLearnedState() {
        localStorage.setItem(LEARNED_STORAGE_KEY, JSON.stringify(Array.from(learnedCourses)));
    }

    function toggleLearned(courseId) {
        if (learnedCourses.has(courseId)) {
            learnedCourses.delete(courseId);
        } else {
            learnedCourses.add(courseId);
        }
        saveLearnedState();
        
        // ã‚°ãƒ©ãƒ•ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»ã—ã¦çŠ¶æ…‹ã‚’åæ˜ 
        if (chartInstance) chartInstance.destroy();
        initChart();
        updateApp();
    }

    // ---------------------------------------------------------
    // ã‚¢ãƒ—ãƒªæ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯
    // ---------------------------------------------------------
    function updateApp() {
        if (courseData.length === 0) return;

        let minDistance = Infinity;
        let closestCluster = -1;

        Object.keys(clusterCentroids).forEach(clusterId => {
            const c = clusterCentroids[clusterId];
            const distSq = Math.pow(c.x - userPos.x, 2) + Math.pow(c.y - userPos.y, 2);
            if (distSq < minDistance) {
                minDistance = distSq;
                closestCluster = parseInt(clusterId);
            }
        });

        const commentDiv = document.getElementById('cluster-comment');
        const clusterInfo = clusterDescriptions[closestCluster] || clusterDescriptions[4];
        commentDiv.innerHTML = `
            <p class="text-lg font-bold text-gray-400">ã‚ãªãŸã®ã‚¿ã‚¤ãƒ—è¨ºæ–­</p>
            <p class="text-lg font-bold text-cyan-400 mt-1">${clusterInfo.title}</p>
            <p class="text-xs font-bold text-gray-300 mt-1">${clusterInfo.desc}</p>
        `;

        const clusterCourses = courseData
            .filter(c => c.cluster === closestCluster)
            .sort((a, b) => a.originalIndex - b.originalIndex);
        updateTable(clusterCourses);

        updateChart();
    }

    function updateTable(courses) {
        const tbody = document.getElementById('recommendation-table');
        tbody.innerHTML = '';
        
        if (courses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-6 text-center text-gray-500">è©²å½“ãªã—</td></tr>';
            return;
        }

        courses.forEach((course) => {
            const isLearned = learnedCourses.has(course.id);
            const tr = document.createElement('tr');
            tr.className = "hover:bg-slate-800/80 transition-colors border-b border-slate-700/50 last:border-0";
            
            // â‘  ãƒœã‚¿ãƒ³çŠ¶æ…‹ã®å®šç¾©
            const btnText = isLearned ? 'å­¦ç¿’æ¸ˆ' : 'æœªå­¦ç¿’';
            const btnClass = isLearned 
                ? 'bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-500/30 border border-green-500' 
                : 'bg-slate-700 hover:bg-slate-600 text-gray-400 hover:text-white border border-slate-600';
            
            tr.innerHTML = `
                <td class="px-4 py-3 font-bold text-center text-gray-500 align-top pt-4">#${course.id}</td>
                <td class="px-4 py-3">
                    <div class="font-bold text-cyan-400 text-sm mb-1">${course.name}</div>
                    <div class="text-xs text-gray-400 leading-relaxed">${course.desc || ''}</div>
                </td>
                <td class="px-4 py-3 text-center align-middle">
                    <button onclick="toggleLearned(${course.id})" class="text-xs font-bold py-1 px-3 rounded-lg transition-all transform active:scale-95 ${btnClass}">
                        ${btnText}
                    </button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // ---------------------------------------------------------
    // Chart.js è¨­å®š
    // ---------------------------------------------------------
    function initChart() {
        const ctx = document.getElementById('scatterChart').getContext('2d');
        
        const datasets = [];
        const clusters = [...new Set(courseData.map(c => c.cluster))].sort((a, b) => a - b);

        // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
        clusters.forEach(clusterId => {
            const clusterItems = courseData.filter(c => c.cluster === clusterId);
            const colorDef = clusterColors[clusterId] || clusterColors[4];

            datasets.push({
                label: `Cluster ${clusterId}`,
                data: clusterItems.map(c => ({ x: c.f1, y: c.f2, name: c.name, id: c.id })),
                backgroundColor: colorDef.bg,
                borderColor: colorDef.border,
                
                pointBorderColor: function(context) {
                    const raw = context.raw;
                    if (raw && raw.id && learnedCourses.has(raw.id)) {
                        return '#FCD34D'; // Gold
                    }
                    return colorDef.border;
                },
                pointBorderWidth: function(context) {
                    const raw = context.raw;
                    if (raw && raw.id && learnedCourses.has(raw.id)) {
                        return 3; 
                    }
                    return 1;
                },
                pointRadius: function(context) {
                    const raw = context.raw;
                    if (raw && raw.id && learnedCourses.has(raw.id)) {
                        return 8; 
                    }
                    return 6;
                },
                pointHoverRadius: 10
            });
        });

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¾åœ¨åœ°
        datasets.push({
            label: 'ã‚ãªãŸ',
            data: [{ x: userPos.x, y: userPos.y }], 
            backgroundColor: 'rgba(255, 255, 255, 0)', 
            borderColor: '#ffffff',
            borderWidth: 3,
            pointRadius: 15,
            pointStyle: 'star',
            pointHoverRadius: 18,
            order: 0 
        });

        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = '#334155';

        chartInstance = new Chart(ctx, {
            type: 'scatter',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        reverse: true,
                        min: -5.0,
                        max: 3.0,
                        grid: { color: 'rgba(51, 65, 85, 0.5)', borderDash: [2, 2] },
                        ticks: { display: false },
                        title: { display: false }
                    },
                    y: {
                        reverse: true,
                        min: -2.0,
                        max: 1.5,
                        grid: { color: 'rgba(51, 65, 85, 0.5)', borderDash: [2, 2] },
                        ticks: { display: false },
                        title: { display: false }
                    }
                },
                plugins: {
                    legend: { 
                        display: true,
                        position: 'bottom',
                        labels: { usePointStyle: true, boxWidth: 8, color: '#cbd5e1', font: { size: 10 }, padding: 20 }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#22d3ee', // Cyan
                        bodyColor: '#e2e8f0',
                        borderColor: 'rgba(148, 163, 184, 0.2)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return context.raw.name ? ` ${context.raw.name}` : ' ã‚ãªãŸ';
                            },
                            afterLabel: function(context) {
                                if (context.raw && context.raw.id && learnedCourses.has(context.raw.id)) {
                                    return ' (å­¦ç¿’æ¸ˆ)';
                                }
                                return '';
                            }
                        }
                    }
                }
            }
        });
    }

    function updateChart() {
        if (!chartInstance) return;
        const myDatasetIndex = chartInstance.data.datasets.length - 1;
        if (chartInstance.data.datasets[myDatasetIndex].label === 'ã‚ãªãŸ') {
            chartInstance.data.datasets[myDatasetIndex].data = [{ x: userPos.x, y: userPos.y }];
        }
        chartInstance.update('none'); 
    }

    // ---------------------------------------------------------
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ---------------------------------------------------------
    function updateCurrentTime() {
        const now = new Date();
        const dateString = now.toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' });
        const timeString = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        document.getElementById('current-time').textContent = `${dateString} ${timeString}`;
    }

    function getWeatherEmoji(code) {
        if (code === 0) return 'â˜€ï¸'; 
        if (code === 1 || code === 2 || code === 3) return 'â›…'; 
        if (code === 45 || code === 48) return 'ğŸŒ«ï¸'; 
        if (code >= 51 && code <= 55) return 'ğŸŒ§ï¸'; 
        if (code >= 56 && code <= 57) return 'ğŸŒ§ï¸'; 
        if (code >= 61 && code <= 65) return 'â˜”'; 
        if (code >= 66 && code <= 67) return 'â˜”'; 
        if (code >= 71 && code <= 77) return 'â„ï¸'; 
        if (code >= 80 && code <= 82) return 'ğŸŒ§ï¸'; 
        if (code >= 85 && code <= 86) return 'â„ï¸'; 
        if (code >= 95) return 'âš¡'; 
        if (code >= 96 && code <= 99) return 'â›ˆï¸'; 
        return 'â“';
    }

    async function fetchWeatherData() {
        const cities = {
            'æœ­å¹Œ': { lat: 43.0642, lon: 141.3469 },
            'ä»™å°': { lat: 38.2688, lon: 140.8722 },
            'æ±äº¬': { lat: 35.6762, lon: 139.6503 },
            'é‡‘æ²¢': { lat: 36.5613, lon: 136.6562 },
            'åå¤å±‹': { lat: 35.1815, lon: 136.9066 },
            'å¤§é˜ª': { lat: 34.6937, lon: 135.5023 },
            'ç¦å²¡': { lat: 33.5904, lon: 130.4017 },
            'é‚£è¦‡': { lat: 26.2128, lon: 127.6798 }
        };
        try {
            for (const [city, coords] of Object.entries(cities)) {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lon}&current=temperature_2m,relative_humidity_2m,weather_code&timezone=Asia/Tokyo`
                );
                const data = await response.json();
                const temp = Math.round(data.current.temperature_2m);
                const humidity = data.current.relative_humidity_2m;
                const weatherCode = data.current.weather_code;
                const emoji = getWeatherEmoji(weatherCode);

                const weatherElement = document.querySelector(`#weather-info`);
                if (weatherElement) {
                    const cityDiv = Array.from(weatherElement.querySelectorAll('div')).find(div => div.textContent.startsWith(city));
                    if (cityDiv) {
                        cityDiv.innerHTML = `${city}: <span class="text-gray-300 font-bold">${emoji} ${temp}Â°C <span class="text-[10px] text-cyan-400">  ğŸ’§æ¹¿ ${humidity}%</span></span>`;
                    }
                }
            }
        } catch (error) {
            console.error('å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
    }

    function loadState() {
        const savedX = localStorage.getItem('slider-x-value');
        const savedY = localStorage.getItem('slider-y-value');
        if (savedX !== null) {
            document.getElementById('slider-x').value = savedX;
            document.getElementById('slider-x').dispatchEvent(new Event('input'));
        }
        if (savedY !== null) {
            document.getElementById('slider-y').value = savedY;
            document.getElementById('slider-y').dispatchEvent(new Event('input'));
        }
    }

    function saveState() {
        localStorage.setItem('slider-x-value', document.getElementById('slider-x').value);
        localStorage.setItem('slider-y-value', document.getElementById('slider-y').value);
    }

    document.getElementById('slider-x').addEventListener('input', saveState);
    document.getElementById('slider-y').addEventListener('input', saveState);
    window.addEventListener('DOMContentLoaded', loadState);

    // ---------------------------------------------------------
    // ä»Šæ—¥ã®åè¨€æ©Ÿèƒ½
    // ---------------------------------------------------------
    const quotesDb = [
        { text: "å½¼ã‚’çŸ¥ã‚Šå·±ã‚’çŸ¥ã‚Œã°ç™¾æˆ¦æ®†ã†ã‹ã‚‰ãš", author: "å­«å­" },
        { text: "å¤©æ‰ã¨ã¯ã€1%ã®ã²ã‚‰ã‚ãã¨99%ã®åŠªåŠ›ã§ã‚ã‚‹", author: "ãƒˆãƒ¼ãƒã‚¹ãƒ»ã‚¨ã‚¸ã‚½ãƒ³" },
        { text: "æœ€å¤§ã®åèª‰ã¯æ±ºã—ã¦å€’ã‚Œãªã„ã“ã¨ã§ã¯ãªã„ã€‚å€’ã‚Œã‚‹ãŸã³ã«èµ·ãä¸ŠãŒã‚‹ã“ã¨ã§ã‚ã‚‹", author: "å­”å­" },
        { text: "å¤¢è¦‹ã‚‹ã“ã¨ãŒã§ãã‚Œã°ã€ãã‚Œã¯å®Ÿç¾ã§ãã‚‹", author: "ã‚¦ã‚©ãƒ«ãƒˆãƒ»ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼" },
        { text: "æœªæ¥ã‚’äºˆæ¸¬ã™ã‚‹æœ€è‰¯ã®æ–¹æ³•ã¯ã€æœªæ¥ã‚’å‰µã‚‹ã“ã¨ã ", author: "ã‚¢ãƒ©ãƒ³ãƒ»ã‚±ã‚¤" },
        { text: "æˆåŠŸã¨ã¯ã€æƒ…ç†±ã‚’å¤±ã‚ãšã«å¤±æ•—ã‚’é‡ã­ã¦ã„ãèƒ½åŠ›ã®ã“ã¨ã ", author: "ã‚¦ã‚£ãƒ³ã‚¹ãƒˆãƒ³ãƒ»ãƒãƒ£ãƒ¼ãƒãƒ«" },
        { text: "åƒã®é“ã®ã‚Šã‚‚ä¸€æ­©ã‹ã‚‰", author: "è€å­" },
        { text: "å­¦ã³ã¦æ€ã‚ã–ã‚Œã°å‰‡ã¡ç½”ï¼ˆãã‚‰ï¼‰ã—ã€æ€ã„ã¦å­¦ã°ã–ã‚Œã°å‰‡ã¡æ®†ï¼ˆã‚ã‚„ã†ï¼‰ã—", author: "å­”å­" },
        { text: "Stay hungry, stay foolish.", author: "ã‚¹ãƒ†ã‚£ãƒ¼ãƒ–ãƒ»ã‚¸ãƒ§ãƒ–ã‚º" },
        { text: "æƒ…å ±ã¯çŸ¥è­˜ã§ã¯ãªã„ã€‚çŸ¥è­˜ã®æºã¯çµŒé¨“ã®ã¿ã§ã‚ã‚‹", author: "ã‚¢ãƒ«ãƒãƒ¼ãƒˆãƒ»ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³" },
        { text: "æ˜æ—¥æ­»ã¬ã‹ã®ã‚ˆã†ã«ç”Ÿãã‚ˆã€‚æ°¸é ã«ç”Ÿãã‚‹ã‹ã®ã‚ˆã†ã«å­¦ã¹", author: "ãƒãƒãƒˆãƒãƒ»ã‚¬ãƒ³ãƒ‡ã‚£ãƒ¼" },
        { text: "å¤±æ•—ã‚’æã‚Œã‚‹ãªã€‚å¤±æ•—ã¯æˆé•·ã®æ¯ã§ã‚ã‚‹ã€‚", author: "æ¾ä¸‹å¹¸ä¹‹åŠ©" },
        { text: "ã‚„ã£ã¦ã¿ãªã¯ã‚Œã€‚ã‚„ã‚‰ãªã‚ã‹ã‚‰ã—ã¾ã¸ã‚“ã§ã€‚", author: "æœ¬ç”°å®—ä¸€éƒ" },
        { text: "æ•™è‚²ã®æ ¹ã¯è‹¦ã„ãŒã€ãã®å®Ÿã¯ç”˜ã„ã€‚", author: "ã‚¢ãƒªã‚¹ãƒˆãƒ†ãƒ¬ã‚¹" },
        { text: "ç¬¬ä¸€ã«è‡ªåˆ†ã®äººç”Ÿã‚’è¨ˆç”»ã›ã‚ˆã€‚ãã†ã™ã‚Œã°ä»–äººã«æ“ã‚‰ã‚Œã‚‹ã“ã¨ã¯ãªã„ã€‚", author: "ã‚¹ãƒ†ã‚£ãƒ¼ãƒ–ãƒ³ãƒ»Rãƒ»ã‚³ãƒ´ã‚£ãƒ¼" },
        { text: "äººç”Ÿã¯å­¦ã³ã®é€£ç¶šã§ã‚ã‚Šã€å­¦ã³ãŒäººç”Ÿã‚’è±Šã‹ã«ã™ã‚‹ã€‚", author: "ãƒ¬ãƒ•ãƒ»ãƒˆãƒ«ã‚¹ãƒˆã‚¤" },
        { text: "å‡ºæ¥ã‚‹ã¨æ€ãˆã°å‡ºæ¥ã‚‹ã€‚å‡ºæ¥ãªã„ã¨æ€ãˆã°å‡ºæ¥ãªã„ã€‚", author: "ãƒ˜ãƒ¬ãƒ³ãƒ»ã‚±ãƒ©ãƒ¼" },
        { text: "äºŒåå¹´å¾Œã€ã‚ãªãŸã¯ã‚„ã£ãŸã“ã¨ã‚ˆã‚Šã‚‚ã‚„ã‚‰ãªã‹ã£ãŸã“ã¨ã«å¤±æœ›ã™ã‚‹ã ã‚ã†ã€‚", author: "ãƒãƒ¼ã‚¯ãƒ»ãƒˆã‚¦ã‚§ã‚¤ãƒ³" },
        { text: "è‡ªåˆ†ã‚’ä¿¡ã˜ã‚ˆã€‚ãã‚ŒãŒäººç”Ÿã®å‡ºç™ºç‚¹ã§ã‚ã‚‹ã€‚", author: "ã‚¦ã‚£ãƒªã‚¢ãƒ ãƒ»ã‚·ã‚§ã‚¤ã‚¯ã‚¹ãƒ”ã‚¢" },
        { text: "æˆåŠŸã¨ã¯ã€å°ã•ãªåŠªåŠ›ã‚’é‡ã­ã‚‹ã“ã¨ã®ç©ã¿é‡ã­ã§ã‚ã‚‹ã€‚", author: "ãƒ“ãƒ«ãƒ»ã‚²ã‚¤ãƒ„" },
        { text: "åŠªåŠ›ã¯å¿…ãšã—ã‚‚å ±ã‚ã‚Œãªã„ã€‚ã—ã‹ã—ã€åŠªåŠ›ã—ãªã‘ã‚Œã°ä½•ã‚‚å§‹ã¾ã‚‰ãªã„ã€‚", author: "ã‚¤ã‚½ãƒƒãƒ—" },
        { text: "ç¶™ç¶šã¯åŠ›ãªã‚Š", author: "ã“ã¨ã‚ã–" },
        { text: "å¤±æ•—ã¯æˆåŠŸã®ã‚‚ã¨", author: "ã“ã¨ã‚ã–" },
        { text: "å°ã•ãªåŠªåŠ›ã®ç©ã¿é‡ã­ãŒå¤§ããªé•ã„ã‚’ç”Ÿã‚€", author: "åŒ¿å" },
        { text: "æŒ‘æˆ¦ã—ãªã„è€…ã«æˆé•·ãªã—", author: "åŒ¿å" },
        { text: "å­¦ã¶ã“ã¨ã¯è‡ªåˆ†ã¸ã®æŠ•è³‡ã ", author: "åŒ¿å" },
        { text: "ä»Šæ—¥ã§ãã‚‹ã“ã¨ã‚’æ˜æ—¥ã«å»¶ã°ã™ãª", author: "åŒ¿å" },
        { text: "å¥½å¥‡å¿ƒãŒæœªæ¥ã‚’é–‹ã", author: "åŒ¿å" },
        { text: "è‡ªåˆ†ã‚’ä¿¡ã˜ã¦ä¸€æ­©è¸ã¿å‡ºãã†", author: "åŒ¿å" },
        { text: "ã§ãã‚‹ã‹ã©ã†ã‹ã‚ˆã‚Šã€ã‚„ã‚‹ã‹ã©ã†ã‹ã ", author: "åŒ¿å" },
        { text: "ç›®æ¨™ã¯å°ã•ãã€ç¿’æ…£ã¯å¤§ãã", author: "åŒ¿å" },
        { text: "èˆˆå‘³ã¯æœ€é«˜ã®æ•™å¸«ã ", author: "åŒ¿å" },
        { text: "è€ƒãˆã‚‹ã ã‘ã§ãªãæ‰‹ã‚’å‹•ã‹ã›", author: "åŒ¿å" },
        { text: "æœ¬å½“ã®å¼·ã•ã¯ç¶šã‘ã‚‰ã‚Œã‚‹ã“ã¨", author: "åŒ¿å" },
        { text: "ä»Šæ—¥ã®åŠªåŠ›ãŒæ˜æ—¥ã®è‡ªä¿¡ã«ãªã‚‹", author: "åŒ¿å" },
        { text: "ã¤ã¾ãšã„ãŸã‚‰ç«‹ã¡ä¸ŠãŒã‚Œã°ã„ã„", author: "åŒ¿å" },
        { text: "ã»ã‚“ã®å°‘ã—ã®æ”¹å–„ãŒæœªæ¥ã‚’å¤‰ãˆã‚‹", author: "åŒ¿å" },
        { text: "ä»–äººã¨æ¯”ã¹ã‚‹ã‚ˆã‚Šæ˜¨æ—¥ã®è‡ªåˆ†ã¨æ¯”ã¹ã‚ˆ", author: "åŒ¿å" },
        { text: "ã¾ãšã¯å¥½ããªã“ã¨ã‚’ç¶šã‘ã¦ã¿ã‚ˆã†", author: "åŒ¿å" },
        { text: "ç›®çš„ãŒã‚ã‚‹äººã¯é“ã«è¿·ã‚ãªã„", author: "åŒ¿å" },
        { text: "é–“é•ã„ã¯å­¦ã³ã€æ¥ã˜ã‚‹ã“ã¨ã¯ãªã„", author: "åŒ¿å" },
        { text: "ä½•äº‹ã‚‚é”æˆã™ã‚‹ã¾ã§ã¯ä¸å¯èƒ½ã«è¦‹ãˆã‚‹", author: "ãƒãƒ«ã‚½ãƒ³ãƒ»ãƒãƒ³ãƒ‡ãƒ©" },
        { text: "é–“é•ã„ã‚’çŠ¯ã—ãŸã“ã¨ã®ãªã„äººã¯ã€ä½•ã‚‚æ–°ã—ã„ã“ã¨ã‚’ã—ãŸã“ã¨ãŒãªã„äººã ", author: "ã‚¢ãƒ«ãƒãƒ¼ãƒˆãƒ»ã‚¢ã‚¤ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³" },
        { text: "çŸ¥ã‚‹ã ã‘ã§ã¯ä¸ååˆ†ã ã€å¿œç”¨ã›ã‚ˆã€‚é¡˜ã†ã ã‘ã§ã¯ä¸ååˆ†ã ã€è¡Œå‹•ã›ã‚ˆ", author: "ã‚²ãƒ¼ãƒ†" }
    ];

    function displayRandomQuote() {
        const quoteText = document.getElementById('quote-text');
        const quoteAuthor = document.getElementById('quote-author');
        if (!quoteText || !quoteAuthor) return;

        const randomIndex = Math.floor(Math.random() * quotesDb.length);
        const quote = quotesDb[randomIndex];

        quoteText.textContent = quote.text;
        quoteAuthor.textContent = quote.author;
    }


    // ---------------------------------------------------------
    // å­¦ç¿’è¨˜éŒ²æ©Ÿèƒ½
    // ---------------------------------------------------------
    const LEARNING_RECORD_KEY = 'moodle-app-learning-record';
    
    function initializeLearningRecord() {
        const saveBtn = document.getElementById('save-record-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', saveAndDownloadRecord);
        }
        renderRecordHistory();
    }

    function getRecordHistory() {
        const stored = localStorage.getItem(LEARNING_RECORD_KEY);
        if (stored) {
            try {
                return JSON.parse(stored);
            } catch(e) { console.error(e); }
        }
        return [];
    }

    function renderRecordHistory() {
        const historyList = document.getElementById('record-history-list');
        if (!historyList) return;

        const records = getRecordHistory();
        historyList.innerHTML = '';

        if (records.length === 0) {
            historyList.innerHTML = '<p class="text-gray-500 text-center mt-10">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            return;
        }

        records.slice().reverse().forEach(record => {
            const div = document.createElement('div');
            div.className = "bg-slate-800 p-3 rounded border border-slate-700 hover:border-slate-500 transition-colors";
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs text-yellow-400 font-bold">${record.date}</span>
                </div>
                <ul class="list-decimal list-inside text-gray-300 pl-1 space-y-1">
                    <li>${record.lines[0] || '(æœªå…¥åŠ›)'}</li>
                    <li>${record.lines[1] || '(æœªå…¥åŠ›)'}</li>
                    <li>${record.lines[2] || '(æœªå…¥åŠ›)'}</li>
                </ul>
            `;
            historyList.appendChild(div);
        });
    }

    function saveAndDownloadRecord() {
        const l1 = document.getElementById('record-line-1').value;
        const l2 = document.getElementById('record-line-2').value;
        const l3 = document.getElementById('record-line-3').value;

        if (!l1 && !l2 && !l3) {
            alert("å°‘ãªãã¨ã‚‚1ã¤ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const now = new Date();
        const dateStr = now.toLocaleString('ja-JP');
        const newRecord = {
            date: dateStr,
            lines: [l1, l2, l3]
        };

        const history = getRecordHistory();
        history.push(newRecord);
        localStorage.setItem(LEARNING_RECORD_KEY, JSON.stringify(history));

        renderRecordHistory();

        downloadRecordAsText(history);

        document.getElementById('record-line-1').value = '';
        document.getElementById('record-line-2').value = '';
        document.getElementById('record-line-3').value = '';
    }

    function downloadRecordAsText(history) {
        let content = "=== å­¦ç¿’è¨˜éŒ²å±¥æ­´ ===\n\n";
        history.forEach(rec => {
            content += `[æ—¥æ™‚] ${rec.date}\n`;
            content += `1. : ${rec.lines[0]}\n`;
            content += `2. : ${rec.lines[1]}\n`;
            content += `3. : ${rec.lines[2]}\n`;
            content += "----------------------------\n";
        });

        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `learning_history_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ---------------------------------------------------------
    // é›†ä¸­ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
    // ---------------------------------------------------------
    let timerInterval = null;
    let timerSeconds = 25 * 60;
    let isTimerRunning = false;

    function updateTimerDisplay() {
        const m = Math.floor(timerSeconds / 60);
        const s = timerSeconds % 60;
        const display = document.getElementById('timer-display');
        if (display) {
            display.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
    }

    window.setTimer = function(minutes) {
        stopTimer();
        timerSeconds = minutes * 60;
        updateTimerDisplay();
    };

    function startTimer() {
        if (isTimerRunning) return;
        isTimerRunning = true;
        const startBtn = document.getElementById('timer-start-btn');
        if (startBtn) {
            startBtn.textContent = "PAUSE";
            startBtn.classList.remove('bg-cyan-600', 'hover:bg-cyan-500', 'shadow-cyan-500/20');
            startBtn.classList.add('bg-orange-500', 'hover:bg-orange-400', 'shadow-orange-500/20');
        }

        timerInterval = setInterval(() => {
            if (timerSeconds > 0) {
                timerSeconds--;
                updateTimerDisplay();
            } else {
                stopTimer();
                alert("æ™‚é–“ã§ã™ï¼ä¼‘æ†©ã—ã¾ã—ã‚‡ã†ã€‚");
            }
        }, 1000);
    }

    function stopTimer() {
        isTimerRunning = false;
        if (timerInterval) clearInterval(timerInterval);
        const startBtn = document.getElementById('timer-start-btn');
        if (startBtn) {
            startBtn.textContent = "START";
            startBtn.classList.remove('bg-orange-500', 'hover:bg-orange-400', 'shadow-orange-500/20');
            startBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-500', 'shadow-cyan-500/20');
        }
    }

    function toggleTimer() {
        if (isTimerRunning) {
            stopTimer();
        } else {
            startTimer();
        }
    }

    function resetTimer() {
        stopTimer();
        timerSeconds = 25 * 60;
        updateTimerDisplay();
    }

    document.addEventListener('DOMContentLoaded', () => {
        const startBtn = document.getElementById('timer-start-btn');
        const resetBtn = document.getElementById('timer-reset-btn');
        if (startBtn) startBtn.addEventListener('click', toggleTimer);
        if (resetBtn) resetBtn.addEventListener('click', resetTimer);
    });

    // ---------------------------------------------------------
    // ãƒ•ã‚§ãƒ«ãƒŸæ¨å®šæ©Ÿèƒ½
    // ---------------------------------------------------------
    let fermiChartInstance = null;

    function initializeFermi() {
        const sliders = ['fermi-age', 'fermi-sex', 'fermi-edu', 'fermi-charm', 'fermi-phys', 'fermi-meet'];
        
        sliders.forEach(id => {
            const el = document.getElementById(id);
            const valEl = document.getElementById(`val-${id}`);
            if(el && valEl) {
                el.addEventListener('input', (e) => {
                    const val = e.target.value;
                    valEl.textContent = `${val}%`;
                    const percent = (parseFloat(val) / 100) * 100;
                    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®èƒŒæ™¯è‰²æ›´æ–°ï¼ˆãƒ”ãƒ³ã‚¯ç³»ï¼‰
                    el.style.background = `linear-gradient(to right, #ec4899 ${percent}%, #334155 ${percent}%)`;
                });
                // åˆæœŸèƒŒæ™¯è‰²ã‚»ãƒƒãƒˆ
                const initialVal = el.value;
                const initialPercent = (parseFloat(initialVal) / 100) * 100;
                el.style.background = `linear-gradient(to right, #ec4899 ${initialPercent}%, #334155 ${initialPercent}%)`;
            }
        });

        const calcBtn = document.getElementById('fermi-calc-btn');
        if(calcBtn) {
            calcBtn.addEventListener('click', calculateFermi);
        }
    }

    function calculateFermi() {
        const pop = parseInt(document.getElementById('fermi-pop').value) || 0;
        const r_age = parseInt(document.getElementById('fermi-age').value) / 100;
        const r_sex = parseInt(document.getElementById('fermi-sex').value) / 100;
        const r_edu = parseInt(document.getElementById('fermi-edu').value) / 100;
        const r_charm = parseInt(document.getElementById('fermi-charm').value) / 100;
        const r_phys = parseInt(document.getElementById('fermi-phys').value) / 100;
        const r_meet = parseInt(document.getElementById('fermi-meet').value) / 100;

        // è¨ˆç®—
        const step1 = pop * r_age;
        const step2 = step1 * r_sex;
        const step3 = step2 * r_edu;
        const step4 = step3 * r_charm;
        const step5 = step4 * r_phys;
        const result = step5 * r_meet;

        // çµæœè¡¨ç¤º
        const resultEl = document.getElementById('fermi-result');
        
        // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const startVal = parseInt(resultEl.innerText);
        const endVal = Math.floor(result);
        const duration = 1000;
        const startTime = performance.now();

        function animate(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            // Ease-out
            const ease = 1 - Math.pow(1 - progress, 3);
            
            const current = Math.floor(startVal + (endVal - startVal) * ease);
            resultEl.innerText = current.toLocaleString();

            if (progress < 1) {
                requestAnimationFrame(animate);
            }
        }
        requestAnimationFrame(animate);

        // ãƒãƒ£ãƒ¼ãƒˆæç”»
        const ctx = document.getElementById('fermiChart').getContext('2d');
        if (fermiChartInstance) fermiChartInstance.destroy();

        fermiChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['å…¨äººå£', 'å¹´é½¢åœå†…', 'å¯¾è±¡æ€§åˆ¥', 'å­¦æ­´ãƒ»çŸ¥æ€§', 'æ€§æ ¼', 'å¤–è¦‹', 'å‡ºä¼šã„'],
                datasets: [{
                    label: 'æ®‹å­˜äººæ•°',
                    data: [pop, step1, step2, step3, step4, step5, result],
                    backgroundColor: [
                        'rgba(148, 163, 184, 0.5)', // Slate
                        'rgba(34, 211, 238, 0.5)', // Cyan
                        'rgba(56, 189, 248, 0.5)', // Sky
                        'rgba(129, 140, 248, 0.5)', // Indigo
                        'rgba(168, 85, 247, 0.5)', // Purple
                        'rgba(236, 72, 153, 0.5)', // Pink
                        'rgba(244, 63, 94, 0.8)'   // Rose (Result)
                    ],
                    borderColor: [
                        'rgba(148, 163, 184, 1)',
                        'rgba(34, 211, 238, 1)',
                        'rgba(56, 189, 248, 1)',
                        'rgba(129, 140, 248, 1)',
                        'rgba(168, 85, 247, 1)',
                        'rgba(236, 72, 153, 1)',
                        'rgba(244, 63, 94, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y', // æ¨ªæ£’ã‚°ãƒ©ãƒ•
                scales: {
                    x: {
                        grid: { color: 'rgba(51, 65, 85, 0.3)' },
                        ticks: { color: '#94a3b8' },
                        type: 'logarithmic' // å¯¾æ•°ã‚¹ã‚±ãƒ¼ãƒ«ã«ã—ãªã„ã¨æœ€å¾ŒãŒè¦‹ãˆãªã„ãŸã‚
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#e2e8f0' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        callbacks: {
                            label: function(context) {
                                let val = context.raw;
                                if(val < 1 && val > 0) val = val.toFixed(4);
                                else val = Math.floor(val).toLocaleString();
                                return val + ' äºº';
                            }
                        }
                    }
                }
            }
        });
    }

    // ---------------------------------------------------------
    // AHPï¼ˆéšå±¤åˆ†ææ³•ï¼‰æ©Ÿèƒ½
    // ---------------------------------------------------------
    function initializeAHP() {
        const ids = ['ahp-criteria-1', 'ahp-criteria-2', 'ahp-criteria-3', 'ahp-alt-1', 'ahp-alt-2', 'ahp-alt-3'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('input', updateAHPLabels);
        });

        const calcBtn = document.getElementById('ahp-calc-btn');
        if(calcBtn) calcBtn.addEventListener('click', calculateAHP);

        const saveBtn = document.getElementById('ahp-save-btn');
        if(saveBtn) saveBtn.addEventListener('click', saveAHPResult);

        // åˆå›ãƒ©ãƒ™ãƒ«æ›´æ–°
        updateAHPLabels();
    }

    function updateAHPLabels() {
        const c1 = document.getElementById('ahp-criteria-1').value;
        const c2 = document.getElementById('ahp-criteria-2').value;
        const c3 = document.getElementById('ahp-criteria-3').value;
        const a1 = document.getElementById('ahp-alt-1').value;
        const a2 = document.getElementById('ahp-alt-2').value;
        const a3 = document.getElementById('ahp-alt-3').value;

        // ã‚¯ãƒ©ã‚¹åã§ä¸€æ‹¬æ›´æ–°
        document.querySelectorAll('.ahp-label-c1').forEach(el => el.textContent = c1);
        document.querySelectorAll('.ahp-label-c2').forEach(el => el.textContent = c2);
        document.querySelectorAll('.ahp-label-c3').forEach(el => el.textContent = c3);
        document.querySelectorAll('.ahp-label-a1').forEach(el => el.textContent = a1);
        document.querySelectorAll('.ahp-label-a2').forEach(el => el.textContent = a2);
        document.querySelectorAll('.ahp-label-a3').forEach(el => el.textContent = a3);
    }

    // 3x3è¡Œåˆ—ã®å¹¾ä½•å¹³å‡æ³•ã«ã‚ˆã‚‹ã‚¦ã‚§ã‚¤ãƒˆè¨ˆç®—
    function calcWeightsFromMatrix3x3(val12, val13, val23) {
        // å¯¾è§’æˆåˆ†ã¯1ã€é€†æ•°ã¯ 1/v
        // Matrix:
        // [ 1      v12     v13 ]
        // [ 1/v12  1       v23 ]
        // [ 1/v13  1/v23   1   ]
        
        const m = [
            [1, val12, val13],
            [1/val12, 1, val23],
            [1/val13, 1/val23, 1]
        ];

        // å¹¾ä½•å¹³å‡
        const gm = [0, 0, 0];
        let gmSum = 0;
        for(let i=0; i<3; i++) {
            gm[i] = Math.pow(m[i][0] * m[i][1] * m[i][2], 1/3);
            gmSum += gm[i];
        }

        // æ­£è¦åŒ–(ã‚¦ã‚§ã‚¤ãƒˆ)
        const w = gm.map(v => v / gmSum);

        // æ•´åˆåº¦(CI)ã®ç°¡æ˜“è¨ˆç®— (Lambda max è¿‘ä¼¼)
        // Î»max â‰ˆ Î£(Column Sum * Weight)
        let lambdaMax = 0;
        for(let j=0; j<3; j++) {
            let colSum = m[0][j] + m[1][j] + m[2][j];
            lambdaMax += colSum * w[j];
        }
        
        const ci = (lambdaMax - 3) / 2; // n=3 ãªã®ã§ (Î»-n)/(n-1) => (Î»-3)/2

        return { weights: w, ci: ci };
    }

    function getRadioValue(name) {
        const els = document.getElementsByName(name);
        for(let el of els) {
            if(el.checked) return parseFloat(el.value);
        }
        return 1; // Default
    }

    function calculateAHP() {
        // Step 1: Criteria comparison
        const c12 = getRadioValue('ahp-pair-c-1-2');
        const c13 = getRadioValue('ahp-pair-c-1-3');
        const c23 = getRadioValue('ahp-pair-c-2-3');
        const resCriteria = calcWeightsFromMatrix3x3(c12, c13, c23);

        // Step 2: Alternatives comparison for Criteria 1
        const a1_12 = getRadioValue('ahp-pair-a1-1-2');
        const a1_13 = getRadioValue('ahp-pair-a1-1-3');
        const a1_23 = getRadioValue('ahp-pair-a1-2-3');
        const resAlt1 = calcWeightsFromMatrix3x3(a1_12, a1_13, a1_23);

        // Step 3: Alternatives comparison for Criteria 2
        const a2_12 = getRadioValue('ahp-pair-a2-1-2');
        const a2_13 = getRadioValue('ahp-pair-a2-1-3');
        const a2_23 = getRadioValue('ahp-pair-a2-2-3');
        const resAlt2 = calcWeightsFromMatrix3x3(a2_12, a2_13, a2_23);

        // Step 4: Alternatives comparison for Criteria 3
        const a3_12 = getRadioValue('ahp-pair-a3-1-2');
        const a3_13 = getRadioValue('ahp-pair-a3-1-3');
        const a3_23 = getRadioValue('ahp-pair-a3-2-3');
        const resAlt3 = calcWeightsFromMatrix3x3(a3_12, a3_13, a3_23);

        // ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—
        // Score(A) = W(C1)*W(A|C1) + W(C2)*W(A|C2) + W(C3)*W(A|C3)
        const scores = [0, 0, 0];
        for(let i=0; i<3; i++) {
            scores[i] = resCriteria.weights[0] * resAlt1.weights[i] +
                        resCriteria.weights[1] * resAlt2.weights[i] +
                        resCriteria.weights[2] * resAlt3.weights[i];
        }

        // è¡¨ç¤ºæ›´æ–°
        document.getElementById('ahp-result-area').classList.remove('hidden');

        // ã‚¹ã‚³ã‚¢è¡¨ç¤º
        document.getElementById('ahp-score-1').textContent = scores[0].toFixed(3);
        document.getElementById('ahp-score-2').textContent = scores[1].toFixed(3);
        document.getElementById('ahp-score-3').textContent = scores[2].toFixed(3);

        // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
        document.getElementById('ahp-w-c1').textContent = resCriteria.weights[0].toFixed(3);
        document.getElementById('ahp-w-c2').textContent = resCriteria.weights[1].toFixed(3);
        document.getElementById('ahp-w-c3').textContent = resCriteria.weights[2].toFixed(3);

        document.getElementById('ahp-w-a1-c1').textContent = resAlt1.weights[0].toFixed(3);
        document.getElementById('ahp-w-a1-c2').textContent = resAlt2.weights[0].toFixed(3);
        document.getElementById('ahp-w-a1-c3').textContent = resAlt3.weights[0].toFixed(3);
        document.getElementById('ahp-total-a1').textContent = scores[0].toFixed(3);

        document.getElementById('ahp-w-a2-c1').textContent = resAlt1.weights[1].toFixed(3);
        document.getElementById('ahp-w-a2-c2').textContent = resAlt2.weights[1].toFixed(3);
        document.getElementById('ahp-w-a2-c3').textContent = resAlt3.weights[1].toFixed(3);
        document.getElementById('ahp-total-a2').textContent = scores[1].toFixed(3);

        document.getElementById('ahp-w-a3-c1').textContent = resAlt1.weights[2].toFixed(3);
        document.getElementById('ahp-w-a3-c2').textContent = resAlt2.weights[2].toFixed(3);
        document.getElementById('ahp-w-a3-c3').textContent = resAlt3.weights[2].toFixed(3);
        document.getElementById('ahp-total-a3').textContent = scores[2].toFixed(3);

        // æ•´åˆåº¦ãƒã‚§ãƒƒã‚¯ (CI >= 0.15 ãªã‚‰è­¦å‘Š)
        const maxCI = Math.max(resCriteria.ci, resAlt1.ci, resAlt2.ci, resAlt3.ci);
        const msgEl = document.getElementById('ahp-consistency-msg');
        if (maxCI >= 0.15) {
            msgEl.classList.remove('hidden');
            msgEl.innerHTML = `âš ï¸ æ•´åˆåº¦(CI)ãŒé«˜ã„ç®‡æ‰€ãŒã‚ã‚Šã¾ã™(Max: ${maxCI.toFixed(3)})ã€‚ç‰¹ã«ã€Œ${maxCI === resCriteria.ci ? 'è©•ä¾¡åŸºæº–' : 'ä»£æ›¿æ¡ˆ'}ã€ã®æ¯”è¼ƒã§çŸ›ç›¾ãŒç”Ÿã˜ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
        } else {
            msgEl.classList.add('hidden');
        }

        // ä¿å­˜ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’DOMè¦ç´ ã«ä¸€æ™‚ä¿å­˜
        document.getElementById('ahp-result-area').dataset.lastResult = JSON.stringify({
            criteria: resCriteria,
            alt1: resAlt1,
            alt2: resAlt2,
            alt3: resAlt3,
            scores: scores,
            ci_max: maxCI
        });
    }

    function saveAHPResult() {
        const goal = document.getElementById('ahp-goal').value;
        const cNames = [
            document.getElementById('ahp-criteria-1').value,
            document.getElementById('ahp-criteria-2').value,
            document.getElementById('ahp-criteria-3').value
        ];
        const aNames = [
            document.getElementById('ahp-alt-1').value,
            document.getElementById('ahp-alt-2').value,
            document.getElementById('ahp-alt-3').value
        ];

        const resultDataStr = document.getElementById('ahp-result-area').dataset.lastResult;
        if(!resultDataStr) {
            alert("è¨ˆç®—ã‚’è¡Œã£ã¦ã‹ã‚‰ä¿å­˜ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        const res = JSON.parse(resultDataStr);

        let text = "=== AHPï¼ˆéšå±¤åˆ†ææ³•ï¼‰ æ„æ€æ±ºå®šãƒ¬ãƒãƒ¼ãƒˆ ===\n\n";
        text += `[ç›®çš„] ${goal}\n`;
        text += `[æ—¥æ™‚] ${new Date().toLocaleString('ja-JP')}\n\n`;

        text += "--- 1. ç·åˆè©•ä¾¡çµæœ ---\n";
        aNames.forEach((name, i) => {
            text += `${name} : ${res.scores[i].toFixed(4)}\n`;
        });
        
        // å‹è€…åˆ¤å®š
        let maxScore = -1;
        let winnerIndex = -1;
        res.scores.forEach((s, i) => {
            if(s > maxScore) { maxScore = s; winnerIndex = i; }
        });
        text += `\n>> æœ€ã‚‚æ¨å¥¨ã•ã‚Œã‚‹é¸æŠè‚¢: ${aNames[winnerIndex]}\n\n`;

        text += "--- 2. è©•ä¾¡åŸºæº–ã®é‡è¦åº¦ (ã‚¦ã‚§ã‚¤ãƒˆ) ---\n";
        cNames.forEach((name, i) => {
            text += `${name} : ${res.criteria.weights[i].toFixed(4)}\n`;
        });
        text += `(æ•´åˆåº¦ CI: ${res.criteria.ci.toFixed(4)})\n\n`;

        text += "--- 3. ä»£æ›¿æ¡ˆã®è©•ä¾¡è©³ç´° ---\n";
        text += `[${cNames[0]}] è¦–ç‚¹:\n`;
        aNames.forEach((name, i) => text += `  ${name}: ${res.alt1.weights[i].toFixed(4)}\n`);
        text += `  (CI: ${res.alt1.ci.toFixed(4)})\n\n`;

        text += `[${cNames[1]}] è¦–ç‚¹:\n`;
        aNames.forEach((name, i) => text += `  ${name}: ${res.alt2.weights[i].toFixed(4)}\n`);
        text += `  (CI: ${res.alt2.ci.toFixed(4)})\n\n`;

        text += `[${cNames[2]}] è¦–ç‚¹:\n`;
        aNames.forEach((name, i) => text += `  ${name}: ${res.alt3.weights[i].toFixed(4)}\n`);
        text += `  (CI: ${res.alt3.ci.toFixed(4)})\n`;

        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ahp_decision_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ---------------------------------------------------------
    // é¡”è¡¨æƒ…èªè­˜æ©Ÿèƒ½
    // ---------------------------------------------------------
    let emotionVideoStream = null;
    let emotionInterval = null;
    let isModelLoaded = false;

    const targetEmotions = {
        'happy': 'ç¬‘é¡”', 'surprised': 'é©šã', 'sad': 'æ‚²ã—ã¿',
        'angry': 'æ€’ã‚Š', 'neutral': 'ç„¡è¡¨æƒ…', 'disgusted': 'ä¸å¿«', 'fearful': 'ææ€–'
    };

    function updateStatus(msg, color = "text-gray-300") {
        const el = document.getElementById('emotion-result');
        if (el) el.innerHTML = `<p class="${color} font-bold text-lg">${msg}</p>`;
        console.log(`[Status] ${msg}`);
    }

    async function initializeEmotionDetection() {
        if (window.location.protocol === 'file:') {
            console.warn('file:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã¯å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
        }

        try {
            updateStatus("AIã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ä¸­...", "text-cyan-400");
            
            if (faceapi.tf) {
                await faceapi.tf.ready();
            }

            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@master/weights';
            
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);

            isModelLoaded = true;
            updateStatus("æº–å‚™å®Œäº†ï¼šã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„", "text-green-400");

        } catch (error) {
            console.error('Model loading error:', error);
            updateStatus(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, "text-red-400");
        }
    }

    async function startEmotionCamera() {
        const modal = document.getElementById('emotion-modal');
        const video = document.getElementById('emotion-video');
        const canvas = document.getElementById('emotion-canvas');
        
        if (!isModelLoaded) {
            alert("AIãƒ¢ãƒ‡ãƒ«ã®æº–å‚™ä¸­ã§ã™ã€‚ã‚‚ã†å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚");
            return;
        }

        if (!video || !canvas) {
            return;
        }

        modal.classList.remove('hidden');
        updateStatus("ã‚«ãƒ¡ãƒ©æ˜ åƒã‚’å–å¾—ä¸­...", "text-gray-300");

        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                },
                audio: false
            });
            
            emotionVideoStream = stream;
            video.srcObject = stream;
            
            await video.play();
            
            const checkVideoSize = () => {
                if (video.videoWidth > 0 && video.videoHeight > 0) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    detectLoop(video, canvas);
                } else {
                    setTimeout(checkVideoSize, 100);
                }
            };
            checkVideoSize();

        } catch (error) {
            updateStatus(`ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${error.message}`, "text-red-400");
            alert('ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚ŒãŸã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
        }
    }

    async function detectLoop(video, canvas) {
        if (!video || !canvas || video.paused || video.ended) return;

        if (emotionInterval) clearInterval(emotionInterval);

        const options = new faceapi.TinyFaceDetectorOptions({ 
            inputSize: 416,
            scoreThreshold: 0.3
        });

        const ctx = canvas.getContext('2d');
        faceapi.matchDimensions(canvas, { width: video.videoWidth, height: video.videoHeight });

        updateStatus("AIè§£æã‚¹ã‚¿ãƒ¼ãƒˆï¼", "text-green-400");
        
        let frameCount = 0;

        emotionInterval = setInterval(async () => {
            if (video.paused || video.ended || !emotionVideoStream) return;

            try {
                const detections = await faceapi
                    .detectAllFaces(video, options)
                    .withFaceExpressions();

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (detections && detections.length > 0) {
                    const resizedDetections = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });

                    faceapi.draw.drawDetections(canvas, resizedDetections);

                    const expressions = resizedDetections[0].expressions;
                    const sorted = Object.entries(expressions).sort(([,a],[,b]) => b - a);
                    const [maxEmotion, maxScore] = sorted[0];
                    const label = targetEmotions[maxEmotion] || maxEmotion;
                    const scorePercent = Math.round(maxScore * 100);

                    const box = resizedDetections[0].detection.box;
                    const textX = box.x + box.width / 2;
                    const textY = box.y - 10;

                    ctx.font = 'bold 24px "Noto Sans JP", sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#f97316'; // Orange
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 4;
                    ctx.strokeText(`${label} (${scorePercent}%)`, textX, textY);
                    ctx.fillText(`${label} (${scorePercent}%)`, textX, textY);

                    const resultEl = document.getElementById('emotion-result');
                    if (resultEl) {
                        resultEl.innerHTML = `
                            <div class="text-center">
                                <p class="text-3xl font-bold text-green-400 mb-1">${label}</p>
                                <p class="text-sm text-gray-300">ç¢ºä¿¡åº¦: ${scorePercent}%</p>
                            </div>
                        `;
                    }
                } else {
                    frameCount++;
                    if (frameCount % 10 === 0) {
                        const resultEl = document.getElementById('emotion-result');
                        if (resultEl) resultEl.innerHTML = `<p class="text-yellow-400 font-bold">é¡”ã‚’æ¢ã—ã¦ã„ã¾ã™...</p>`;
                    }
                }

            } catch (error) {
                console.error('Detection error:', error);
            }
        }, 200);
    }

    function captureEmotionSnapshot() {
        const el = document.getElementById('emotion-result');
        if (el) {
            const text = el.innerText.replace(/\n/g, ' ');
            alert(`ç¾åœ¨ã®çŠ¶æ…‹: ${text}`);
        }
    }

    function closeEmotionModal() {
        const modal = document.getElementById('emotion-modal');
        const video = document.getElementById('emotion-video');
        const canvas = document.getElementById('emotion-canvas');
        
        modal.classList.add('hidden');
        
        if (emotionVideoStream) {
            emotionVideoStream.getTracks().forEach(track => track.stop());
            emotionVideoStream = null;
        }
        
        if (emotionInterval) {
            clearInterval(emotionInterval);
            emotionInterval = null;
        }
        
        if (video) {
            video.srcObject = null;
            video.pause();
        }
        
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        updateStatus("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„", "text-gray-300");
    }

    document.addEventListener('DOMContentLoaded', () => {
        const emotionBtn = document.getElementById('emotion-btn');
        if (emotionBtn) emotionBtn.addEventListener('click', startEmotionCamera);

        const captureBtn = document.getElementById('capture-emotion-btn');
        if (captureBtn) captureBtn.addEventListener('click', captureEmotionSnapshot);

        const closeBtn = document.getElementById('close-emotion-modal');
        if (closeBtn) closeBtn.addEventListener('click', closeEmotionModal);

        const modal = document.getElementById('emotion-modal');
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeEmotionModal();
            });
        }
    });

    // ---------------------------------------------------------
    // ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæ©Ÿèƒ½
    // ---------------------------------------------------------
    const CHAT_STORAGE_KEY = 'moodle-app-chat-history';
    let chatHistory = [];
    let mlcEngine = null;
    let isModelLoading = false;
    const SELECTED_MODEL = "Llama-3.2-1B-Instruct-q4f32_1-MLC";

    function initializeWebLLMChatbot() {
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-chat-btn');
        const resetBtn = document.getElementById('reset-chat-btn');

        const savedHistory = localStorage.getItem(CHAT_STORAGE_KEY);
        if (savedHistory) {
            try {
                chatHistory = JSON.parse(savedHistory);
            } catch(e) { console.error(e); }
        }

        renderChat();

        if(sendBtn) sendBtn.addEventListener('click', handleWebLLMChatSend);
        if(resetBtn) resetBtn.addEventListener('click', resetChat);
        if(chatInput) {
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleWebLLMChatSend();
            });
        }
    }

    function renderChat() {
        const container = document.getElementById('chat-container');
        if (!container) return;

        if (chatHistory.length === 0) {
            container.innerHTML = `
                <div class="text-center text-gray-400 text-sm mt-20">
                    <p class="mb-2 text-3xl">ğŸ¤–</p>
                    <p>å­¦ç¿’ã®æ‚©ã¿ã‚„é€²æ—ã‚’è©±ã—ã‹ã‘ã¦ãã ã•ã„ã€‚<br>ã‚ãªãŸã®ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§å‹•ãAIãŒå¿œæ´ã—ã¾ã™ï¼</p>
                    <p class="text-xs text-slate-500 mt-2">â€»åˆå›ã®ã¿AIãƒ¢ãƒ‡ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒç™ºç”Ÿã—ã¾ã™</p>
                </div>`;
        } else {
            container.innerHTML = '';
            chatHistory.forEach(msg => {
                const div = document.createElement('div');
                const isBot = msg.role === 'assistant';
                div.className = `flex mb-3 ${isBot ? 'justify-start' : 'justify-end'}`;
                
                const contentClass = isBot 
                    ? 'bg-slate-700 text-gray-100 rounded-2xl rounded-tl-none border border-slate-600'
                    : 'bg-blue-600 text-white rounded-2xl rounded-tr-none shadow-lg shadow-blue-600/20';

                let htmlContent = msg.content;
                if (typeof marked !== 'undefined' && isBot) {
                    htmlContent = marked.parse(msg.content);
                } else {
                    htmlContent = msg.content.replace(/\n/g, '<br>');
                }

                div.innerHTML = `
                    <div class="max-w-[85%] px-4 py-3 ${contentClass} text-sm">
                        ${htmlContent}
                    </div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }
    }

    async function getMLCEngine() {
        if (mlcEngine) return mlcEngine;

        const statusDiv = document.getElementById('llm-status');
        const progressBar = document.getElementById('llm-progress-bar');
        const statusText = document.getElementById('llm-status-text');
        if(statusDiv) statusDiv.classList.remove('hidden');
        isModelLoading = true;

        try {
            const { CreateMLCEngine } = await import('https://esm.run/@mlc-ai/web-llm');

            const initProgressCallback = (report) => {
                console.log('Loading:', report.text);
                if(statusText) statusText.innerText = report.text;
                if (report.progress && progressBar) {
                    progressBar.style.width = `${report.progress * 100}%`;
                }
            };

            mlcEngine = await CreateMLCEngine(
                SELECTED_MODEL,
                { initProgressCallback: initProgressCallback }
            );

            if(statusDiv) statusDiv.classList.add('hidden');
            isModelLoading = false;
            return mlcEngine;

        } catch (error) {
            console.error("WebLLM Load Error:", error);
            alert("AIãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚WebGPUå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
            if(statusDiv) statusDiv.classList.add('hidden');
            isModelLoading = false;
            return null;
        }
    }

    async function handleWebLLMChatSend() {
        const inputEl = document.getElementById('chat-input');
        const text = inputEl.value.trim();
        if (!text || isModelLoading) return;

        chatHistory.push({ role: 'user', content: text });
        inputEl.value = '';
        renderChat();
        saveChatHistory();

        const container = document.getElementById('chat-container');
        
        let loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex mb-3 justify-start';
        loadingDiv.id = 'chat-loading-bubble';
        loadingDiv.innerHTML = `<div class="bg-slate-700 text-cyan-400 px-4 py-3 rounded-2xl rounded-tl-none text-xs flex items-center gap-2"><span class="animate-pulse">â—</span> AIãŒè€ƒãˆã¦ã„ã¾ã™...</div>`;
        container.appendChild(loadingDiv);
        container.scrollTop = container.scrollHeight;

        const engine = await getMLCEngine();
        if (!engine) {
            document.getElementById('chat-loading-bubble')?.remove();
            return;
        }

        const systemPrompt = "ã‚ãªãŸã¯è¦ªåˆ‡ãªå­¦ç¿’ãƒ¡ãƒ³ã‚¿ãƒ¼ã§ã™ã€‚é«˜æ ¡ç”Ÿã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’ã‚’å…·ä½“çš„ã«åŠ±ã¾ã—ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã«å¿œç­”ã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬èªã§ç­”ãˆã¦ãã ã•ã„ã€‚";
        
        const messages = [
            { role: "system", content: systemPrompt },
            ...chatHistory.slice(-5)
        ];

        try {
            const reply = await engine.chat.completions.create({
                messages: messages,
                temperature: 0.7,
                max_tokens: 256, 
            });

            const botResponse = reply.choices[0].message.content;

            document.getElementById('chat-loading-bubble')?.remove();

            chatHistory.push({ role: 'assistant', content: botResponse });
            renderChat();
            saveChatHistory();

        } catch (err) {
            console.error(err);
            document.getElementById('chat-loading-bubble')?.remove();
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
        }
    }

    function resetChat() {
        if(confirm("ä¼šè©±å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€åˆã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) {
            chatHistory = [];
            saveChatHistory();
            if(mlcEngine) {
                mlcEngine.resetChat();
            }
            renderChat();
        }
    }

    function saveChatHistory() {
        localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(chatHistory));
    }
    </script>
</body>
</html>